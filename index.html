<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>BebCom Delivery - Pedido Online</title>
    
    <!-- SEO -->
    <meta name="description" content="BebCom Delivery - Bebidas, drinks e muito mais. Pe√ßa pelo WhatsApp!">
    <meta name="keywords" content="delivery, bebidas, drinks, cerveja, whisky, gin, vodka, bauru, salgadinhos, doces">
    <meta name="author" content="BebCom Delivery">
    
    <!-- PWA -->
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Open Graph -->
    <meta property="og:title" content="BebCom Delivery">
    <meta property="og:description" content="Seu delivery de bebidas em Bauru">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçπ</text></svg>">
    
    <!-- Mercado Pago SDK (para redirecionamento) -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <style>
        /* ... (seus estilos CSS permanecem exatamente iguais, n√£o vou repetir aqui por brevidade, mas devem ser mantidos) ... */
        /* Copie e cole todo o bloco de estilos do arquivo anterior aqui. */
    </style>
</head>
<body>
    <!-- Bot√£o Admin -->
    <button class="admin-button" id="adminButton" title="Painel Administrativo">üîß</button>

    <!-- MODAL DE VERIFICA√á√ÉO DE IDADE -->
    <div class="age-verification-modal" id="ageVerificationModal">
        <!-- ... (conte√∫do do modal de idade) ... -->
    </div>

    <div class="header">üçπ BEBCOM DELIVERY</div>

    <div class="nav-container">
        <!-- ... (bot√µes de navega√ß√£o) ... -->
    </div>

    <div class="main-container">
        <!-- CARD√ÅPIO -->
        <div class="menu-section">
            <h2 class="section-title">üìã Card√°pio</h2>
            <div class="categories-grid" id="categoriesGrid"></div>
            <div class="products-grid" id="productsGrid">
                <div style="text-align: center; color: #aaa; padding: 50px; grid-column: 1/-1;">
                    üçπ Selecione uma categoria para ver os produtos
                </div>
            </div>
        </div>

        <!-- CARRINHO -->
        <div class="cart-section">
            <h2 class="section-title">üõí Carrinho</h2>
            
            <div class="cart-items" id="cartItems">
                <div style="text-align: center; color: #aaa; padding: 40px;">
                    Seu carrinho est√° vazio
                </div>
            </div>

            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span>R$ <span id="subtotal">0.00</span></span>
                </div>
                <div class="total-row" id="deliveryRow" style="display: none;">
                    <span>Taxa de Entrega:</span>
                    <span>R$ <span id="deliveryFee">0.00</span></span>
                </div>
                <div class="total-row" id="distanceRow" style="display: none;">
                    <span>Dist√¢ncia:</span>
                    <span><span id="distanceValue">0.0</span> km</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total:</span>
                    <span>R$ <span id="totalAmount">0.00</span></span>
                </div>
            </div>

            <!-- Dados do Cliente -->
            <div class="customer-section">
                <div class="form-group">
                    <label class="form-label">üë§ Nome Completo *</label>
                    <input type="text" class="form-input" id="customerName" placeholder="Digite seu nome" autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">üì± WhatsApp *</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="(14) 99999-9999" autocomplete="tel">
                </div>
                <div class="form-group">
                    <label class="form-label">‚úâÔ∏è E-mail (para pagamento) *</label>
                    <input type="email" class="form-input" id="customerEmail" placeholder="seu@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label">üÜî CPF (para pagamento) *</label>
                    <input type="text" class="form-input" id="customerCpf" placeholder="000.000.000-00" autocomplete="off">
                </div>
            </div>

            <!-- Tipo de Pedido -->
            <div class="delivery-section">
                <label class="form-label">üì¶ Tipo de Pedido</label>
                <div class="delivery-options">
                    <div class="delivery-option selected" onclick="selectDeliveryType('pickup')">üè™ Retirada</div>
                    <div class="delivery-option" onclick="selectDeliveryType('delivery')">üöö Entrega</div>
                </div>

                <div id="addressFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">üìç Endere√ßo de Entrega *</label>
                        <div class="address-row">
                            <input type="text" class="form-input" id="street" placeholder="Rua/Avenida" autocomplete="address-line1">
                            <input type="text" class="form-input" id="number" placeholder="N√∫mero" autocomplete="address-line2">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="address-row-2">
                            <input type="text" class="form-input" id="neighborhood" placeholder="Bairro" autocomplete="address-level4">
                            <input type="text" class="form-input" id="city" placeholder="Cidade" value="Bauru" autocomplete="address-level2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üè† Complemento (opcional)</label>
                        <input type="text" class="form-input" id="addressComplement" placeholder="Apto, Bloco, Refer√™ncia">
                    </div>
                    <div class="form-group">
                        <button class="secondary-button" id="calculateDeliveryBtn" onclick="calculateDeliveryFee()" style="padding: 12px; font-size: 14px;">üßÆ Calcular Entrega</button>
                    </div>
                    <div id="deliveryCalculationStatus" style="font-size: 14px; margin-top: 5px; color: #ffc107;"></div>
                </div>
            </div>

            <!-- Pagamento -->
            <div class="payment-section">
                <label class="form-label" id="paymentLabel" style="display: none;">üí≥ Pagamento</label>
                <div class="payment-methods" id="paymentMethods" style="display: none;">
                    <div class="payment-method selected" onclick="selectPaymentMethod('credit_card')">
                        <div class="payment-icon">üí≥</div>
                        <div>Cart√£o de Cr√©dito/D√©bito</div>
                    </div>
                </div>

                <div id="paymentStatus" class="payment-status" style="display: none;"></div>

                <button class="primary-button" id="payButton" disabled onclick="processPayment()">
                    üí∞ Pagar com Cart√£o
                </button>

                <button class="secondary-button" id="whatsappButton" disabled onclick="sendToWhatsApp()">
                    üì± Enviar Pedido (Aguardando Pagamento)
                </button>

                <button class="clear-button" onclick="clearCart()">
                    üóëÔ∏è Limpar Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SABORES -->
    <div class="flavor-modal-overlay" id="flavorModal">
        <div class="flavor-modal-content">
            <h2 class="flavor-modal-title" id="flavorModalTitle">Escolha o sabor</h2>
            <div style="text-align: center; color: #aaa; margin-bottom: 20px;" id="flavorModalInstruction">
                Selecione uma op√ß√£o
            </div>
            <div class="flavors-grid" id="flavorsGrid"></div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="modal-button confirm" id="confirmFlavorButton" onclick="confirmFlavorSelection()" style="flex: 1; padding: 16px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    ‚úÖ Confirmar
                </button>
                <button class="modal-button cancel" onclick="cancelFlavorSelection()" style="flex: 1; padding: 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ADMINISTRATIVO -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <div class="admin-header">
                <h2 class="admin-title">üîß Gerenciamento</h2>
                <button class="admin-close" id="adminClose">√ó</button>
            </div>

            <div class="admin-password" id="passwordSection">
                <h3 style="color: #60a5fa; margin-bottom: 20px; text-align: center;">üîê Acesso Administrativo</h3>
                <input type="password" class="password-input" id="adminPassword" placeholder="Digite a senha">
                <button class="password-button" onclick="checkAdminPassword()">
                    Entrar
                </button>
            </div>

            <div class="admin-main" id="adminMain" style="display: none; padding: 20px 30px; max-height: 60vh; overflow-y: auto;">
                <!-- Categorias ser√£o carregadas dinamicamente -->
            </div>

            <div class="admin-actions" id="adminActions" style="display: none;">
                <button class="admin-action-btn all-btn" onclick="setAllAvailable(true)">‚úÖ Todos Dispon√≠vel</button>
                <button class="admin-action-btn none-btn" onclick="setAllAvailable(false)">‚ùå Todos Indispon√≠vel</button>
                <button class="admin-action-btn save-btn" onclick="saveAvailability()">üíæ Salvar no Servidor</button>
                <button class="admin-action-btn reset-btn" onclick="resetAvailability()">üîÑ Restaurar Padr√£o</button>
                <button class="admin-action-btn" onclick="openFlavorManagement()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">üçπ Gerenciar Sabores</button>
                <button class="admin-action-btn" onclick="syncAllFromServer()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">üîÑ Sincronizar do Servidor</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO INICIAL (SEGURA)
        // ============================================
        let CONFIG = {
            backendUrl: 'https://bebcom-delivery-api-1980-bchkauhjf0djajag.brazilsouth-01.azurewebsites.net',
            whatsappNumber: '5514996130369',
            mercadoPago: {
                publicKey: null,
                testMode: false
            },
            storeLocation: {
                lat: -22.35892,
                lng: -49.0987233,
                address: "R. Jos√© Henrique Ferraz, 18-10 - Centro, Bauru - SP"
            },
            deliveryRates: {
                baseFee: 5.00,
                perKm: 2.65,
                maxDistance: 15,
                minDistance: 0.5,
                freeDeliveryMin: 100.00
            },
            version: '4.0.0-azure-producao',
            environment: 'production'
        };

        // ============================================
        // DADOS DOS PRODUTOS (FONTE √öNICA DA VERDADE)
        // ============================================
        const products = { /* ... (seus produtos permanecem exatamente iguais) ... */ };
        const FLAVOR_CATALOG = { /* ... (seu cat√°logo de sabores permanece igual) ... */ };
        const FLAVOR_TYPES = { /* ... (seus tipos de sabor permanecem iguais) ... */ };

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        const state = {
            cart: [],
            currentCategory: 'drinks-whisky',
            deliveryType: 'pickup',
            paymentMethod: 'pix',
            paymentConfirmed: false,
            paymentProcessing: false,
            currentOrderId: null,
            pendingProduct: null,
            pendingFlavors: {},
            currentFlavorStep: null,
            currentButton: null,
            adminAuthenticated: false,
            adminToken: null,
            productAvailability: {},
            flavorAvailability: {},
            ageVerified: false,
            backendOnline: null,
            offlineSince: null,
            syncQueue: [],
            mpInstance: null,
            deliveryDistance: null,
            deliveryFee: 0,
            preferenceId: null,
            paymentStatus: null,
            paymentCheckInterval: null,
            // NOVO: Flag para controlar se j√° enviou WhatsApp
            whatsappSent: false
        };

        // ============================================
        // FUN√á√ïES AUXILIARES (loadSecureConfig, initMercadoPago, etc.)
        // ============================================
        async function loadSecureConfig() { /* ... (c√≥digo inalterado) ... */ }
        function initMercadoPago() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // VERIFICA√á√ÉO DE IDADE
        // ============================================
        function initAgeVerification() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // FUN√á√ÉO PARA CRIAR O GRID DE CATEGORIAS (CORRIGIDO)
        // ============================================
        function showCategoriesGrid() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = '';
            
            const categories = [
                { id: 'drinks-whisky', name: 'ü•É Drinks Whisky' },
                { id: 'drinks-gin', name: 'üç∏ Drinks Gin' },
                { id: 'drinks-vodka', name: 'üç∏ Drinks Vodka' },
                { id: 'drinks-vinho', name: 'üç∑ Drinks Vinho' },
                { id: 'cervejas', name: 'üç∫ Cervejas' },
                { id: 'destilados', name: 'ü•É Destilados' },
                { id: 'aguas', name: 'üíß √Åguas' },
                { id: 'refri-latas', name: 'ü•§ Refri Latas' },
                { id: 'refri-pet', name: 'ü•§ Refri PET' },
                { id: 'sucos', name: 'üßÉ Sucos' },
                { id: 'energeticos', name: '‚ö° Energ√©ticos' },
                { id: 'gelo-carvao', name: 'üßä Gelo/Carv√£o' },
                { id: 'salgadinhos', name: 'ü•® Salgadinhos' },
                { id: 'doces', name: 'üç¨ Doces' }
            ];
            
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-button';
                btn.textContent = cat.name;
                btn.onclick = () => showCategory(cat.id);
                grid.appendChild(btn);
            });
        }

        // ============================================
        // INICIALIZA√á√ÉO P√ìS-VERIFICA√á√ÉO DE IDADE
        // ============================================
        async function initAfterAgeVerification() {
            console.log('‚úÖ Inicializando interface...');
            
            recoverPendingOrder();
            
            await loadAvailability();
            loadCart();
            showCategoriesGrid(); // <--- ESSA LINHA √â CRUCIAL (estava faltando)
            showCategory('drinks-whisky');
            setupEventListeners();
            setupPhoneMask();
            setupCpfMask();
            selectDeliveryType('pickup');
            
            // NOVO: Carregar dados salvos do cliente se existirem
            loadSavedCustomerData();
            
            setInterval(checkBackendHealth, 300000);
            checkForPaymentReturn();
        }

        // ============================================
        // NOVAS FUN√á√ïES PARA SALVAR/CARREGAR DADOS DO CLIENTE
        // ============================================
        function saveCustomerDataBeforePayment() { /* ... (c√≥digo inalterado) ... */ }
        function loadSavedCustomerData() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // RECUPERAR PEDIDO PENDENTE
        // ============================================
        function recoverPendingOrder() { /* ... (c√≥digo inalterado) ... */ }
        function checkForPaymentReturn() { /* ... (c√≥digo inalterado) ... */ }
        function confirmPaymentSuccess(orderId, paymentId) { /* ... (c√≥digo inalterado) ... */ }
        async function checkPaymentStatus(orderId, paymentId) { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // STORAGE MANAGEMENT
        // ============================================
        function initStorage() { /* ... (c√≥digo inalterado) ... */ }
        async function checkBackendHealth() { /* ... (c√≥digo inalterado) ... */ }
        async function loadAvailability() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // FUN√á√ïES DE PRODUTO
        // ============================================
        function isProductAvailable(productId) { /* ... (c√≥digo inalterado) ... */ }
        function isFlavorAvailable(flavorType, flavorName) { /* ... (c√≥digo inalterado) ... */ }
        function findProductById(productId) { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // EXIBIR CATEGORIA
        // ============================================
        function showCategory(categoryId) { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // ADICIONAR AO CARRINHO
        // ============================================
        function handleAddToCart(productId, button) { /* ... (c√≥digo inalterado) ... */ }
        function openFlavorModal(product, step) { /* ... (c√≥digo inalterado) ... */ }
        function confirmFlavorSelection() { /* ... (c√≥digo inalterado) ... */ }
        function cancelFlavorSelection() { /* ... (c√≥digo inalterado) ... */ }
        function addToCartWithFlavors() { /* ... (c√≥digo inalterado) ... */ }
        function addToCartDirect(product, button) { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // FUN√á√ïES DO CARRINHO
        // ============================================
        function updateCart() { /* ... (c√≥digo inalterado) ... */ }
        function updateQuantity(index, change) { /* ... (c√≥digo inalterado) ... */ }
        function removeFromCart(index) { /* ... (c√≥digo inalterado) ... */ }
        function clearCart() { /* ... (c√≥digo inalterado) ... */ }
        function saveCart() { /* ... (c√≥digo inalterado) ... */ }
        function loadCart() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // C√ÅLCULO DE TAXA DE ENTREGA
        // ============================================
        async function calculateDeliveryFee() { /* ... (c√≥digo inalterado) ... */ }
        function calculateDistance(lat1, lon1, lat2, lon2) { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // M√ÅSCARAS
        // ============================================
        function setupCpfMask() { /* ... (c√≥digo inalterado) ... */ }
        function setupPhoneMask() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // ENTREGA E PAGAMENTO
        // ============================================
        function selectDeliveryType(type) { /* ... (c√≥digo inalterado) ... */ }
        function selectPaymentMethod(method) { /* ... (c√≥digo inalterado) ... */ }

        function validateForm() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const cpf = document.getElementById('customerCpf').value.trim();
            const whatsappBtn = document.getElementById('whatsappButton');
            let isValid = true;
            
            if (name.length < 3) isValid = false;
            
            const phoneClean = phone.replace(/\D/g, '');
            if (phoneClean.length < 10 || phoneClean.length > 11) isValid = false;
            
            if (state.deliveryType === 'delivery') {
                if (!email || !email.includes('@') || !email.includes('.')) isValid = false;
                
                const cpfClean = cpf.replace(/\D/g, '');
                if (cpfClean.length !== 11) isValid = false;
                
                const street = document.getElementById('street').value.trim();
                const number = document.getElementById('number').value.trim();
                const neighborhood = document.getElementById('neighborhood').value.trim();
                
                if (!street || street.length < 3) isValid = false;
                if (!number) isValid = false;
                if (!neighborhood || neighborhood.length < 3) isValid = false;
                
                if (!state.deliveryDistance) isValid = false;
                
                if (state.paymentConfirmed) {
                    // NOVO: Desabilitar se j√° enviou
                    whatsappBtn.disabled = state.whatsappSent;
                    whatsappBtn.innerHTML = 'üì± Enviar Pedido (Pago)';
                } else {
                    whatsappBtn.disabled = true;
                    whatsappBtn.innerHTML = 'üì± Enviar Pedido (Aguardando Pagamento)';
                }
            } else {
                whatsappBtn.disabled = !(state.cart.length > 0 && name.length >= 3 && phoneClean.length >= 10);
                whatsappBtn.innerHTML = 'üì± Enviar Pedido';
            }
            
            return isValid;
        }

        function validateOrder() { /* ... (c√≥digo inalterado) ... */ }
        function prepareOrderData() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // PROCESSAMENTO DE PAGAMENTO
        // ============================================
        async function processPayment() {
            if (state.deliveryType === 'pickup') {
                showNotification('‚úÖ Pagamento ser√° realizado na retirada', 'info');
                enableWhatsAppButton();
                return;
            }
            
            if (state.paymentProcessing) return;
            
            const errors = validateOrder();
            if (errors.length > 0) { 
                showNotification(errors.join('\n'), 'error'); 
                return; 
            }
            
            if (!state.backendOnline) {
                showNotification('‚ö†Ô∏è Servidor offline. Pagamento n√£o dispon√≠vel no momento.', 'error');
                return;
            }
            
            // NOVO: Salvar dados do cliente antes de redirecionar
            saveCustomerDataBeforePayment();
            
            state.paymentProcessing = true;
            const button = document.getElementById('payButton');
            const original = button.innerHTML;
            const statusDiv = document.getElementById('paymentStatus');
            
            button.innerHTML = '<span class="loading-spinner"></span> Gerando pagamento...';
            button.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'payment-status info';
            statusDiv.innerHTML = 'üîÑ Gerando link de pagamento...';
            
            try {
                const orderData = prepareOrderData();
                const orderId = 'BEB' + Date.now().toString().slice(-8);
                state.currentOrderId = orderId;
                
                const cpf = document.getElementById('customerCpf').value.trim().replace(/\D/g, '');
                
                const customer = {
                    name: document.getElementById('customerName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    cpf: cpf
                };
                
                let address = null;
                if (state.deliveryType === 'delivery') {
                    const street = document.getElementById('street').value.trim();
                    const number = document.getElementById('number').value.trim();
                    const neighborhood = document.getElementById('neighborhood').value.trim();
                    const city = document.getElementById('city').value.trim() || 'Bauru';
                    const complement = document.getElementById('addressComplement').value.trim();
                    
                    address = {
                        street: `${street}, ${number}`,
                        neighborhood: neighborhood,
                        city: city,
                        complement: complement,
                        fullAddress: `${street}, ${number} - ${neighborhood}, ${city}`
                    };
                }
                
                const paymentData = {
                    orderId: orderId,
                    customer: customer,
                    items: orderData.items,
                    total: orderData.total,
                    deliveryFee: orderData.deliveryFee,
                    deliveryType: state.deliveryType,
                    paymentMethod: state.paymentMethod,
                    address: address,
                    notificationUrl: `${CONFIG.backendUrl}/api/webhooks/mercadopago`,
                    redirectUrls: {
                        success: `${window.location.origin}${window.location.pathname}?status=approved&order_id=${orderId}`,
                        failure: `${window.location.origin}${window.location.pathname}?status=failure`,
                        pending: `${window.location.origin}${window.location.pathname}?status=pending`
                    }
                };
                
                const response = await fetch(`${CONFIG.backendUrl}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao criar pagamento');
                }
                
                const data = await response.json();
                
                if (data.success && data.initPoint) {
                    sessionStorage.setItem('bebcom_last_order', JSON.stringify({
                        orderId: orderId,
                        preferenceId: data.preferenceId,
                        confirmed: false,
                        timestamp: Date.now()
                    }));
                    
                    statusDiv.innerHTML = 'üîÑ Redirecionando para o Mercado Pago...';
                    window.location.href = data.initPoint;
                } else {
                    throw new Error('Resposta inv√°lida do servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no pagamento:', error);
                statusDiv.className = 'payment-status error';
                statusDiv.innerHTML = `‚ùå Erro: ${error.message}`;
                button.innerHTML = original;
                button.disabled = false;
                state.paymentProcessing = false;
            }
        }

        function enableWhatsAppButton() {
            state.paymentConfirmed = true;
            state.whatsappSent = false; // NOVO: Resetar flag quando pagamento confirmado
            const whatsappBtn = document.getElementById('whatsappButton');
            whatsappBtn.disabled = false;
            whatsappBtn.innerHTML = 'üì± Enviar Pedido (Pago)';
            validateForm();
        }

        // ============================================
        // WHATSAPP - ATUALIZADO
        // ============================================
        function sendToWhatsApp() {
            if (!validateForm()) { 
                showNotification('Complete todas as informa√ß√µes', 'error'); 
                return; 
            }
            
            if (state.deliveryType === 'delivery' && !state.paymentConfirmed) {
                showNotification('‚ùå Complete o pagamento antes de enviar', 'error');
                return;
            }
            
            // NOVO: Impedir envio duplicado
            if (state.whatsappSent) {
                showNotification('‚ö†Ô∏è Pedido j√° foi enviado!', 'warning');
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const cpf = document.getElementById('customerCpf').value.trim();
            
            const street = document.getElementById('street')?.value.trim() || '';
            const number = document.getElementById('number')?.value.trim() || '';
            const neighborhood = document.getElementById('neighborhood')?.value.trim() || '';
            const city = document.getElementById('city')?.value.trim() || 'Bauru';
            const complement = document.getElementById('addressComplement')?.value.trim() || '';
            
            const order = prepareOrderData();
            const orderId = state.currentOrderId || 'BEB' + Date.now().toString().slice(-8);
            
            let msg = `*üçπ PEDIDO BEBCOM DELIVERY*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã *Pedido:* ${orderId}\nüë§ *Cliente:* ${name}\nüì± *WhatsApp:* ${phone}\n‚úâÔ∏è *E-mail:* ${email}\nüÜî *CPF:* ${cpf}\nüì¶ *Tipo:* ${state.deliveryType === 'delivery' ? 'ENTREGA' : 'RETIRADA'}\n`;
            
            if (state.deliveryType === 'delivery') {
                msg += `üìç *Endere√ßo:* ${street}, ${number}\n`;
                msg += `üèòÔ∏è *Bairro:* ${neighborhood}\n`;
                msg += `üèôÔ∏è *Cidade:* ${city}\n`;
                if (complement) msg += `üè† *Complemento:* ${complement}\n`;
                msg += `üìè *Dist√¢ncia:* ${state.deliveryDistance ? state.deliveryDistance.toFixed(1) + 'km' : 'N/A'}\n`;
                msg += `üí≥ *Pagamento:* Cart√£o ‚úÖ PAGO (Mercado Pago)\n`;
            } else {
                msg += `üí≥ *Pagamento:* Na retirada\n`;
            }
            
            msg += `üïí *Data:* ${new Date().toLocaleString('pt-BR')}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n*üõí ITENS:*\n`;
            
            order.items.forEach((item, i) => {
                const total = item.quantity * item.unit_price;
                msg += `\n${i+1}. ${item.title}\n`;
                if (item.description) msg += `   üìù ${item.description}\n`;
                msg += `   ${item.quantity}x R$ ${item.unit_price.toFixed(2)} = R$ ${total.toFixed(2)}\n`;
            });
            
            msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ *Subtotal:* R$ ${order.subtotal.toFixed(2)}\n`;
            if (state.deliveryType === 'delivery') msg += `üöö *Entrega:* R$ ${order.deliveryFee.toFixed(2)}\n`;
            msg += `üíµ *TOTAL:* R$ ${order.total.toFixed(2)}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ *Pedido confirmado e PAGO!*\nüéâ Obrigado pela prefer√™ncia!`;
            
            window.open(`https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            
            // NOVO: Marcar como enviado e desabilitar bot√£o
            state.whatsappSent = true;
            const whatsappBtn = document.getElementById('whatsappButton');
            whatsappBtn.disabled = true;
            whatsappBtn.innerHTML = '‚úÖ Pedido Enviado';
            
            showNotification('‚úÖ Pedido enviado!');
            
            if (state.deliveryType === 'pickup') {
                state.paymentConfirmed = false;
            }
        }

        // ============================================
        // ADMINISTRA√á√ÉO SEGURA (TUDO INTACTO)
        // ============================================
        function initAdminSystem() { /* ... (c√≥digo inalterado) ... */ }
        function openAdminPanel() { /* ... (c√≥digo inalterado) ... */ }
        function closeAdminPanel() { /* ... (c√≥digo inalterado) ... */ }
        function isAdminAuthenticated() { /* ... (c√≥digo inalterado) ... */ }
        async function checkAdminPassword() { /* ... (c√≥digo inalterado) ... */ }
        function getAdminHeaders() { /* ... (c√≥digo inalterado) ... */ }
        function loadAdminProducts() { /* ... (c√≥digo inalterado) ... */ }
        function adminToggleProductAvailability(productId, isAvailable) { /* ... (c√≥digo inalterado) ... */ }
        function setAllAvailable(isAvailable) { /* ... (c√≥digo inalterado) ... */ }
        async function saveAvailability() { /* ... (c√≥digo inalterado) ... */ }
        function resetAvailability() { /* ... (c√≥digo inalterado) ... */ }
        async function syncAllFromServer() { /* ... (c√≥digo inalterado) ... */ }
        function openFlavorManagement() { /* ... (c√≥digo inalterado) ... */ }
        function loadFlavorsForType(flavorType) { /* ... (c√≥digo inalterado) ... */ }
        function toggleFlavorAvailability(flavorType, flavorName, isAvailable) { /* ... (c√≥digo inalterado) ... */ }
        function setAllFlavorsAvailable(flavorType, makeAvailable) { /* ... (c√≥digo inalterado) ... */ }
        function syncPendingData() { /* ... (c√≥digo inalterado) ... */ }
        function updateMenuAvailability() { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // UTILIT√ÅRIOS
        // ============================================
        function setupEventListeners() { /* ... (c√≥digo inalterado) ... */ }
        function showNotification(msg, type = 'success') { /* ... (c√≥digo inalterado) ... */ }

        // ============================================
        // INICIALIZA√á√ÉO PRINCIPAL
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ BebCom Delivery - Produ√ß√£o com Mercado Pago');
            await loadSecureConfig();
            initStorage();
            initAdminSystem();
            initAgeVerification();
            setTimeout(checkBackendHealth, 2000);
        });

        // ============================================
        // EXPOR FUN√á√ïES GLOBAIS
        // ============================================
        window.showCategory = showCategory;
        window.handleAddToCart = handleAddToCart;
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        window.clearCart = clearCart;
        window.selectDeliveryType = selectDeliveryType;
        window.selectPaymentMethod = selectPaymentMethod;
        window.processPayment = processPayment;
        window.sendToWhatsApp = sendToWhatsApp;
        window.confirmFlavorSelection = confirmFlavorSelection;
        window.cancelFlavorSelection = cancelFlavorSelection;
        window.checkAdminPassword = checkAdminPassword;
        window.setAllAvailable = setAllAvailable;
        window.saveAvailability = saveAvailability;
        window.resetAvailability = resetAvailability;
        window.openFlavorManagement = openFlavorManagement;
        window.loadFlavorsForType = loadFlavorsForType;
        window.toggleFlavorAvailability = toggleFlavorAvailability;
        window.setAllFlavorsAvailable = setAllFlavorsAvailable;
        window.syncAllFromServer = syncAllFromServer;
        window.adminToggleProductAvailability = adminToggleProductAvailability;
        window.loadAdminProducts = loadAdminProducts;
        window.calculateDeliveryFee = calculateDeliveryFee;
    </script>
</body>
</html>
