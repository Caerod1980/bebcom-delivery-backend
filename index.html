<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>BebCom Delivery - Pedido Online</title>
    
    <!-- SEO -->
    <meta name="description" content="BebCom Delivery - Bebidas, drinks e muito mais. Pe√ßa pelo WhatsApp!">
    <meta name="keywords" content="delivery, bebidas, drinks, cerveja, whisky, gin, vodka, bauru, salgadinhos, doces">
    <meta name="author" content="BebCom Delivery">
    
    <!-- PWA -->
    <meta name="theme-color" content="#dc2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Open Graph -->
    <meta property="og:title" content="BebCom Delivery">
    <meta property="og:description" content="Seu delivery de bebidas em Bauru">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçπ</text></svg>">
    
    <!-- Mercado Pago SDK (para redirecionamento, n√£o precisa mais da SDK de cart√£o) -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    
    <style>
        /* ====== SEUS ESTILOS EXATAMENTE IGUAIS - NADA MUDOU ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #4d96ff;
            --secondary-dark: #3b82f6;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #0a0a0a;
            --darker: #1a1a1a;
            --light: #f5f5f5;
            --gray: #94a3b8;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        body {
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            padding-bottom: 30px;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, var(--darker) 100%);
            color: white;
            text-align: center;
            padding: 20px 15px;
            font-size: clamp(24px, 5vw, 28px);
            font-weight: 800;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border-bottom: 3px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            position: sticky;
            top: 70px;
            z-index: 99;
            border-bottom: 1px solid #333;
        }

        .nav-container::-webkit-scrollbar {
            height: 3px;
        }

        .nav-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .nav-button {
            padding: 12px 18px;
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #444;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .nav-button:hover {
            background: rgba(220, 38, 38, 0.9);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        .menu-section, .cart-section {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #333;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease;
        }

        .cart-section {
            position: sticky;
            top: 140px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .cart-section {
                position: static;
                max-height: none;
            }
        }

        .section-title {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: clamp(20px, 4vw, 24px);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 15px;
        }

        /* ===== NOVO ESTILO PARA BARRA DE PESQUISA ===== */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            background: rgba(45, 45, 45, 0.8);
            border: 2px solid #444;
            border-radius: 50px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(45, 45, 45, 0.95);
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.2);
        }

        .search-input::placeholder {
            color: #888;
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--secondary);
            pointer-events: none;
        }

        .search-results-info {
            margin: 10px 0;
            padding: 10px 15px;
            background: rgba(77, 150, 255, 0.1);
            border-radius: 8px;
            color: var(--secondary);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clear-search-btn {
            background: rgba(220, 38, 38, 0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .clear-search-btn:hover {
            background: rgba(220, 38, 38, 0.3);
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
        }

        .category-button {
            background: linear-gradient(135deg, rgba(45, 45, 45, 0.95) 0%, rgba(60, 60, 60, 0.95) 100%);
            border: 1px solid #444;
            padding: 20px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .category-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.2);
            border-color: var(--primary);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .product-card {
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            backdrop-filter: blur(5px);
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(220, 38, 38, 0.15);
            border-color: var(--primary);
        }

        .product-card.unavailable {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(0.8);
        }

        .product-card.unavailable::after {
            content: "INDISPON√çVEL";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 700;
            z-index: 2;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
            line-height: 1.3;
        }

        .product-info {
            font-size: 13px;
            color: var(--gray);
            margin-bottom: 12px;
            flex: 1;
        }

        .product-price {
            font-size: 20px;
            color: var(--primary);
            font-weight: 800;
            text-align: right;
            margin-top: 10px;
        }

        .flavor-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(77, 150, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .add-to-cart-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .add-to-cart-btn.has-flavors {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        }

        .add-to-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
        }

        .add-to-cart-btn.added {
            background: linear-gradient(135deg, var(--success) 0%, #218838 100%);
        }

        .add-to-cart-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none !important;
            box-shadow: none !important;
        }

        .cart-items {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .cart-items::-webkit-scrollbar {
            width: 4px;
        }

        .cart-items::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(45, 45, 45, 0.6);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quantity-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #555;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .remove-item-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            padding: 6px 10px;
            border-radius: 6px;
            margin-left: 8px;
        }

        .remove-item-btn:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .totals-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444;
            font-size: 15px;
        }

        .grand-total {
            font-size: 20px;
            font-weight: 800;
            color: var(--warning);
            border-bottom: none;
            padding-top: 12px;
            border-top: 2px solid #555;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: #ddd;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid #444;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.1);
        }

        .form-input::placeholder {
            color: #666;
        }

        .delivery-options {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .delivery-option {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: rgba(45, 45, 45, 0.6);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .delivery-option.selected {
            border-color: var(--secondary);
            background: rgba(77, 150, 255, 0.15);
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .payment-method {
            padding: 15px;
            background: rgba(45, 45, 45, 0.6);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .payment-method.selected {
            border-color: var(--warning);
            background: rgba(77, 150, 255, 0.15);
        }

        .payment-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .primary-button {
            background: linear-gradient(135deg, var(--success) 0%, #218838 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            width: 100%;
            transition: all 0.2s ease;
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .primary-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }

        .primary-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .secondary-button {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            transition: all 0.2s;
            margin: 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .secondary-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4);
        }

        .secondary-button:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .clear-button {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            margin-top: 12px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .payment-status {
            padding: 16px;
            border-radius: 12px;
            margin: 15px 0;
            background: rgba(255, 217, 61, 0.1);
            border-left: 5px solid var(--warning);
            font-size: 15px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .payment-status.success {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: var(--success);
        }

        .payment-status.error {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger);
        }

        .payment-status.info {
            background: rgba(23, 162, 184, 0.1);
            border-left-color: #17a2b8;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .flavor-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 20000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .flavor-modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid var(--secondary);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            animation: fadeIn 0.4s ease;
        }

        .flavor-modal-title {
            color: var(--secondary);
            text-align: center;
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .flavors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .flavor-option {
            padding: 16px 12px;
            background: rgba(45, 45, 45, 0.7);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
        }

        .flavor-option:hover {
            background: rgba(77, 150, 255, 0.2);
            transform: translateY(-3px);
        }

        .flavor-option.selected {
            border-color: var(--warning);
            background: rgba(255, 217, 61, 0.15);
        }

        .flavor-option.unavailable {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
        }

        .age-verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(15px);
        }

        .age-modal-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--primary);
            box-shadow: 0 25px 70px rgba(0,0,0,0.9);
        }

        .age-modal-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            padding: 25px 30px;
            border-bottom: 2px solid var(--primary);
            text-align: center;
        }

        .age-modal-header h2 {
            color: white;
            font-size: 28px;
            margin: 0;
            font-weight: 800;
        }

        .age-legal-text {
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 16px;
            border-left: 5px solid var(--secondary);
            margin: 20px 0;
        }

        .age-checkbox-container {
            background: rgba(220, 38, 38, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--primary);
            margin-top: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .age-checkbox-container input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-top: 3px;
            accent-color: var(--success);
            cursor: pointer;
        }

        .age-modal-footer {
            padding: 20px 30px;
            display: flex;
            gap: 20px;
            border-top: 1px solid #444;
        }

        .age-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .age-btn-exit {
            background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%);
            color: white;
        }

        .age-btn-enter {
            background: linear-gradient(135deg, var(--success) 0%, #218838 100%);
            color: white;
        }

        .age-btn-enter:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .admin-button {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            transition: all 0.2s;
        }

        .admin-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.7);
        }
        @media (max-width: 768px) {
    .admin-button {
        display: none;
    }
}

        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 10001;
            overflow-y: auto;
            padding: 20px;
        }

        .admin-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            max-width: 1200px;
            margin: 30px auto;
            border-radius: 20px;
            border: 2px solid var(--secondary);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            padding: 20px 30px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-size: 24px;
            font-weight: 800;
            color: #60a5fa;
        }

        .admin-close {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .admin-close:hover {
            transform: scale(1.1);
            background: #b91c1c;
        }

        .admin-password {
            padding: 30px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid #444;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(255,255,255,0.15);
        }

        .password-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .password-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .admin-actions {
            padding: 20px 30px;
            background: rgba(26, 26, 26, 0.8);
            border-top: 1px solid #333;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .admin-action-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .admin-action-btn:hover {
            transform: translateY(-2px);
        }

        .all-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .none-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .save-btn { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .reset-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .nav-container { padding: 10px; }
            .nav-button { padding: 10px 16px; font-size: 13px; }
            .categories-grid { grid-template-columns: repeat(2, 1fr); }
            .products-grid { grid-template-columns: 1fr; }
            .payment-methods { grid-template-columns: 1fr; }
            .delivery-options { flex-direction: column; }
            .flavors-grid { grid-template-columns: 1fr; }
            .age-modal-footer { flex-direction: column; }
            .age-modal-header h2 { font-size: 22px; }
            .admin-header { flex-direction: column; gap: 15px; text-align: center; }
            .admin-actions { flex-direction: column; }
            .admin-action-btn { width: 100%; }
        }

        @media (max-width: 480px) {
            .header { font-size: 20px; padding: 15px; }
            .section-title { font-size: 20px; }
            .product-card { padding: 15px; }
            .product-price { font-size: 18px; }
            .cart-item { flex-direction: column; align-items: flex-start; gap: 12px; }
            .flavor-modal-content { padding: 20px; }
            .admin-title { font-size: 20px; }
        }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none; }

        /* Estilos para os campos de endere√ßo separados */
        .address-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .address-row-2 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Bot√£o Admin -->
    <button class="admin-button" id="adminButton" title="Painel Administrativo">üîß</button>

    <!-- MODAL DE VERIFICA√á√ÉO DE IDADE -->
    <div class="age-verification-modal" id="ageVerificationModal">
        <div class="age-modal-content">
            <div class="age-modal-header">
                <h2>üçπ Verifica√ß√£o de Idade</h2>
            </div>
            <div class="age-modal-body" style="padding: 30px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="font-size: 60px;">‚ö†Ô∏è</span>
                </div>
                <div class="age-legal-text">
                    <p><strong>DECLARA√á√ÉO LEGAL</strong></p>
                    <p>Conforme o <strong>Estatuto da Crian√ßa e do Adolescente (Lei 8.069/90)</strong>, a venda de bebidas alco√≥licas a menores de 18 anos √© proibida.</p>
                    <p>Este site √© destinado exclusivamente a maiores de 18 anos.</p>
                    
                    <div class="age-checkbox-container">
                        <input type="checkbox" id="ageConfirmationCheckbox">
                        <label for="ageConfirmationCheckbox">
                            <strong>DECLARO</strong> que tenho 18 anos ou mais e assumo total responsabilidade por esta declara√ß√£o.
                        </label>
                    </div>
                </div>
            </div>
            <div class="age-modal-footer">
                <button class="age-btn age-btn-exit" onclick="window.location.href='https://www.google.com'">
                    ‚ùå Sair
                    <small style="font-size: 12px;">Menor de 18 anos</small>
                </button>
                <button class="age-btn age-btn-enter" id="enterSiteButton" disabled>
                    ‚úÖ Entrar
                    <small style="font-size: 12px;">Sou maior de 18 anos</small>
                </button>
            </div>
            <div class="age-modal-disclaimer" style="padding: 15px 30px; background: rgba(0,0,0,0.3); text-align: center; color: #94a3b8; font-size: 12px;">
                BebCom Delivery - Consumo moderado. Beba com responsabilidade.
            </div>
        </div>
    </div>

    <div class="header">
        üçπ BEBCOM DELIVERY
    </div>

    <div class="nav-container">
        <button class="nav-button" onclick="showCategory('drinks-whisky'); clearSearch()">ü•É Drinks Whisky</button>
        <button class="nav-button" onclick="showCategory('drinks-gin'); clearSearch()">üç∏ Drinks Gin</button>
        <button class="nav-button" onclick="showCategory('drinks-vodka'); clearSearch()">üç∏ Drinks Vodka</button>
        <button class="nav-button" onclick="showCategory('drinks-vinho'); clearSearch()">üç∑ Drinks Vinho</button>
        <button class="nav-button" onclick="showCategory('cervejas'); clearSearch()">üç∫ Cervejas</button>
        <button class="nav-button" onclick="showCategory('destilados'); clearSearch()">ü•É Destilados</button>
        <button class="nav-button" onclick="showCategory('aguas'); clearSearch()">üíß √Åguas</button>
        <button class="nav-button" onclick="showCategory('refri-latas'); clearSearch()">ü•§ Refri Latas</button>
        <button class="nav-button" onclick="showCategory('refri-pet'); clearSearch()">ü•§ Refri PET</button>
        <button class="nav-button" onclick="showCategory('sucos'); clearSearch()">üßÉ Sucos</button>
        <button class="nav-button" onclick="showCategory('energeticos'); clearSearch()">‚ö° Energ√©ticos</button>
        <button class="nav-button" onclick="showCategory('gelo-carvao'); clearSearch()">üßä Gelo/Carv√£o</button>
        <button class="nav-button" onclick="showCategory('salgadinhos'); clearSearch()">ü•® Salgadinhos</button>
        <button class="nav-button" onclick="showCategory('doces'); clearSearch()">üç¨ Doces</button>
    </div>

    <div class="main-container">
        <!-- CARD√ÅPIO -->
        <div class="menu-section">
            <h2 class="section-title">üìã Card√°pio</h2>
            
            <!-- NOVA BARRA DE PESQUISA -->
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar qualquer produto..." oninput="handleSearch(this.value)">
            </div>
            <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
            
            <div class="categories-grid" id="categoriesGrid"></div>
            <div class="products-grid" id="productsGrid">
                <div style="text-align: center; color: #aaa; padding: 50px; grid-column: 1/-1;">
                    üçπ Selecione uma categoria ou busque por produtos
                </div>
            </div>
        </div>

        <!-- CARRINHO -->
        <div class="cart-section">
            <h2 class="section-title">üõí Carrinho</h2>
            
            <div class="cart-items" id="cartItems">
                <div style="text-align: center; color: #aaa; padding: 40px;">
                    Seu carrinho est√° vazio
                </div>
            </div>

            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span>R$ <span id="subtotal">0.00</span></span>
                </div>
                <div class="total-row" id="deliveryRow" style="display: none;">
                    <span>Taxa de Entrega:</span>
                    <span>R$ <span id="deliveryFee">0.00</span></span>
                </div>
                <div class="total-row" id="distanceRow" style="display: none;">
                    <span>Dist√¢ncia:</span>
                    <span><span id="distanceValue">0.0</span> km</span>
                </div>
                <div class="total-row grand-total">
                    <span>Total:</span>
                    <span>R$ <span id="totalAmount">0.00</span></span>
                </div>
            </div>

            <!-- Dados do Cliente -->
            <div class="customer-section">
                <div class="form-group">
                    <label class="form-label">üë§ Nome Completo *</label>
                    <input type="text" class="form-input" id="customerName" placeholder="Digite seu nome" autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label">üì± WhatsApp *</label>
                    <input type="tel" class="form-input" id="customerPhone" placeholder="(14) 99999-9999" autocomplete="tel">
                </div>
                <div class="form-group">
                    <label class="form-label">‚úâÔ∏è E-mail (para pagamento) *</label>
                    <input type="email" class="form-input" id="customerEmail" placeholder="seu@email.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label">üÜî CPF (para pagamento) *</label>
                    <input type="text" class="form-input" id="customerCpf" placeholder="000.000.000-00" autocomplete="off">
                </div>
            </div>

            <!-- Tipo de Pedido -->
            <div class="delivery-section">
                <label class="form-label">üì¶ Tipo de Pedido</label>
                <div class="delivery-options">
                    <div class="delivery-option selected" onclick="selectDeliveryType('pickup')">üè™ Retirada</div>
                    <div class="delivery-option" onclick="selectDeliveryType('delivery')">üöö Entrega</div>
                </div>

                <div id="addressFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">üìç Endere√ßo de Entrega *</label>
                        <div class="address-row">
                            <input type="text" class="form-input" id="street" placeholder="Rua/Avenida" autocomplete="address-line1">
                            <input type="text" class="form-input" id="number" placeholder="N√∫mero" autocomplete="address-line2">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="address-row-2">
                            <input type="text" class="form-input" id="neighborhood" placeholder="Bairro" autocomplete="address-level4">
                            <input type="text" class="form-input" id="city" placeholder="Cidade" value="Bauru" autocomplete="address-level2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">üè† Complemento (opcional)</label>
                        <input type="text" class="form-input" id="addressComplement" placeholder="Apto, Bloco, Refer√™ncia">
                    </div>
                    <div class="form-group">
                        <button class="secondary-button" id="calculateDeliveryBtn" onclick="calculateDeliveryFee()" style="padding: 12px; font-size: 14px;">üßÆ Calcular Entrega</button>
                    </div>
                    <div id="deliveryCalculationStatus" style="font-size: 14px; margin-top: 5px; color: #ffc107;"></div>
                </div>
            </div>

            <!-- Pagamento -->
            <div class="payment-section">
                <label class="form-label" id="paymentLabel" style="display: none;">üí≥ Pagamento</label>
                <div class="payment-methods" id="paymentMethods" style="display: none;">
                    <div class="payment-method selected" onclick="selectPaymentMethod('credit_card')">
                        <div class="payment-icon">üí≥</div>
                        <div>Cart√£o de Cr√©dito/D√©bito</div>
                    </div>
                </div>

                <div id="paymentStatus" class="payment-status" style="display: none;"></div>

                <button class="primary-button" id="payButton" disabled onclick="processPayment()">
                    üí∞ Pagar com Cart√£o
                </button>

                <button class="secondary-button" id="whatsappButton" disabled onclick="sendToWhatsApp()">
                    üì± Enviar Pedido (Aguardando Pagamento)
                </button>

                <button class="clear-button" onclick="clearCart()">
                    üóëÔ∏è Limpar Carrinho
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL DE SABORES -->
    <div class="flavor-modal-overlay" id="flavorModal">
        <div class="flavor-modal-content">
            <h2 class="flavor-modal-title" id="flavorModalTitle">Escolha o sabor</h2>
            <div style="text-align: center; color: #aaa; margin-bottom: 20px;" id="flavorModalInstruction">
                Selecione uma op√ß√£o
            </div>
            <div class="flavors-grid" id="flavorsGrid"></div>
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="modal-button confirm" id="confirmFlavorButton" onclick="confirmFlavorSelection()" style="flex: 1; padding: 16px; background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    ‚úÖ Confirmar
                </button>
                <button class="modal-button cancel" onclick="cancelFlavorSelection()" style="flex: 1; padding: 16px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL ADMINISTRATIVO -->
    <div class="admin-modal" id="adminModal">
        <div class="admin-content">
            <div class="admin-header">
                <h2 class="admin-title">üîß Gerenciamento</h2>
                <button class="admin-close" id="adminClose">√ó</button>
            </div>

            <div class="admin-password" id="passwordSection">
                <h3 style="color: #60a5fa; margin-bottom: 20px; text-align: center;">üîê Acesso Administrativo</h3>
                <input type="password" class="password-input" id="adminPassword" placeholder="Digite a senha">
                <button class="password-button" onclick="checkAdminPassword()">
                    Entrar
                </button>
            </div>

            <div class="admin-main" id="adminMain" style="display: none; padding: 20px 30px; max-height: 60vh; overflow-y: auto;">
                <!-- Categorias ser√£o carregadas dinamicamente -->
            </div>

            <div class="admin-actions" id="adminActions" style="display: none;">
                <button class="admin-action-btn all-btn" onclick="setAllAvailable(true)">‚úÖ Todos Dispon√≠vel</button>
                <button class="admin-action-btn none-btn" onclick="setAllAvailable(false)">‚ùå Todos Indispon√≠vel</button>
                <button class="admin-action-btn save-btn" onclick="saveAvailability()">üíæ Salvar no Servidor</button>
                <button class="admin-action-btn reset-btn" onclick="resetAvailability()">üîÑ Restaurar Padr√£o</button>
                <button class="admin-action-btn" onclick="openFlavorManagement()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">üçπ Gerenciar Sabores</button>
                <button class="admin-action-btn" onclick="syncAllFromServer()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">üîÑ Sincronizar do Servidor</button>
                <button class="admin-action-btn" onclick="openOrdersPanel()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">üìä Painel de Pedidos</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO INICIAL (SEGURA)
        // ============================================
        let CONFIG = {
            backendUrl: 'https://bebcom-delivery-api-1980-bchkauhjf0djajag.brazilsouth-01.azurewebsites.net',
            whatsappNumber: '5514996130369',
            mercadoPago: {
                publicKey: null, // Ser√° carregado do backend
                testMode: false // Mude para false em produ√ß√£o
            },
            storeLocation: {
                lat: -22.35892,
                lng: -49.0987233,
                address: "R. Jos√© Henrique Ferraz, 18-10 - Centro, Bauru - SP"
            },
            deliveryRates: {
                baseFee: 5.00,
                perKm: 1.05,
                maxDistance: 80,
                minDistance: 0.5,
                freeDeliveryMin: 400.00
            },
            version: '4.0.0-azure-producao',
            environment: 'production'
        };

        // ============================================
        // DADOS DOS PRODUTOS (FONTE √öNICA DA VERDADE)
        // ============================================
        const products = {
            'drinks-whisky': [
                { id: 'old-star', name: 'Cop√£o Old Star', description: 'Drink cl√°ssico de whisky', price: 11.00, requiresFlavorSelection: true, flavorType: 'whisky_oldstar', nextStep: 'ice' },
                { id: 'passport', name: 'Cop√£o Passport', description: 'Whisky importado', price: 18.00, requiresFlavorSelection: true, flavorType: 'whisky_sem_sabor', nextStep: 'ice' },
                { id: 'natu-nobilis', name: 'Cop√£o Natu Nobilis', description: 'Whisky premium', price: 17.00, requiresFlavorSelection: true, flavorType: 'whisky_sem_sabor', nextStep: 'ice' },
                { id: 'white-horse', name: 'Cop√£o White Horse', description: 'Whisky escoc√™s', price: 22.00, requiresFlavorSelection: true, flavorType: 'whisky_sem_sabor', nextStep: 'ice' },
                { id: 'red-label', name: 'Cop√£o Red Label', description: 'Johnnie Walker', price: 25.00, requiresFlavorSelection: true, flavorType: 'whisky_sem_sabor', nextStep: 'ice' },
                { id: 'ballantines', name: 'Cop√£o Ballantines', description: 'Whisky escoc√™s', price: 28.00, requiresFlavorSelection: true, flavorType: 'whisky_sem_sabor', nextStep: 'ice' },
                { id: 'jack-daniels', name: 'Cop√£o Jack Daniels', description: 'Whisky americano', price: 35.00, requiresFlavorSelection: true, flavorType: 'whisky_jack', nextStep: 'ice' }
            ],
            'drinks-gin': [
                { id: 'danoninho-gin', name: 'Danoninho de Gin', description: 'Batida com Gin', price: 18.00, requiresFlavorSelection: true, flavorType: 'gin_sabores' },
                { id: 'copa-gin', name: 'Cop√£o de Gin', description: 'Drink com Gin Askov', price: 18.00, requiresFlavorSelection: true, flavorType: 'gin_sabores', nextStep: 'ice' }
            ],
            'drinks-vodka': [
                { id: 'danoninho-corote', name: 'Danoninho Corote', description: 'Batida com Corote', price: 15.00, requiresFlavorSelection: true, flavorType: 'corote_sabores' },
                { id: 'danoninho-askov', name: 'Danoninho Askov', description: 'Askov de frutas', price: 18.00, requiresFlavorSelection: true, flavorType: 'vodka_sabores' }
            ],
            'drinks-vinho': [
                { id: 'danoninho-vinho', name: 'Danoninho de Vinho', description: 'Batida de vinho', price: 18.00, requiresFlavorSelection: false }
            ],
            'cervejas': [
                { id: 'brahma', name: 'Brahma', description: 'Cerveja tradicional brasileira', price: 4.25 },
                { id: 'skol', name: 'Skol', description: 'Cerveja tradicional brasileira', price: 4.25 },
                { id: 'antarctica', name: 'Antarctica', description: 'Cerveja pilsen refrescante', price: 4.25 },
                { id: 'sub-zero', name: 'Sub-Zero', description: 'Cerveja extra gelada', price: 4.25 },
                { id: 'amstel', name: 'Amstel', description: 'Cerveja holandesa premium', price: 4.00 },
                { id: 'heineken', name: 'Heineken', description: 'Cerveja importada premium', price: 6.50 },
                { id: 'corona-long', name: 'Corona Long', description: 'Cerveja mexicana em long neck', price: 8.50 },
                { id: 'stella-long', name: 'Stella Long', description: 'Cerveja belga em long neck', price: 7.50 },
                { id: 'brahma-zero', name: 'Brahma Zero', description: 'Cerveja sem √°lcool', price: 5.00 },
                { id: 'imperio', name: 'Imperio', description: 'Cerveja brasileira tradicional', price: 3.75 },
                { id: 'duplo-malte', name: 'Duplo Malte', description: 'Cerveja com duplo malte', price: 5.00 },
                { id: 'spaten', name: 'Spaten', description: 'Cerveja alem√£ premium', price: 5.50 },
                { id: 'budweiser', name: 'Budweiser', description: 'Cerveja americana', price: 5.50 },
                { id: 'burguesa', name: 'Burguesa', description: 'Cerveja artesanal brasileira', price: 3.75 },
                { id: 'bavaria', name: 'Bavaria', description: 'Cerveja holandesa', price: 3.25 },
                { id: 'bavaria-latao', name: 'Bavaria Lat√£o', description: 'Cerveja em lata grande', price: 4.75 },
                { id: 'petra', name: 'Petra', description: 'Cerveja brasileira', price: 4.00 },
                { id: 'conti-malzbier', name: 'Conti Malzbier', description: 'Cerveja tipo malzbier', price: 4.50 },
                { id: 'brahma-malz', name: 'Brahma Malz.', description: 'Malzbier da Brahma', price: 4.50 },
                { id: 'moinho-real', name: 'Moinho Real', description: 'Cerveja brasileira', price: 4.00 },
                { id: 'original', name: 'Original', description: 'Cerveja premium', price: 5.50 },
                { id: 'heineken-long', name: 'Heineken Long', description: 'Heineken em long neck', price: 8.50 },
                { id: 'budweiser-long', name: 'Budweiser Long', description: 'Budweiser em long neck', price: 8.00 },
                { id: 'eisenbah-ipa', name: 'Eisenbah IPA', description: 'Cerveja IPA artesanal', price: 8.50 },
                { id: 'stella-gold', name: 'Stella Gold', description: 'Stella Artois premium', price: 8.00 },
                { id: 'amstel-ultra-long', name: 'Amstel Ultra Long', description: 'Cerveja leve em long neck', price: 6.50 },
                { id: 'amstel-ultra', name: 'Amstel Ultra', description: 'Cerveja leve', price: 5.00 },
                { id: 'spaten-long', name: 'Spaten Long', description: 'Spaten em long neck', price: 7.50 },
                { id: 'imperio-gold', name: 'Imp√©rio Gold', description: 'Cerveja premium brasileira', price: 8.00 },
                { id: 'michelob-long', name: 'Michelob Long', description: 'Michelob em long neck', price: 7.50 },
                { id: 'michelob', name: 'Michelob', description: 'Cerveja americana premium', price: 6.00 },
                { id: 'conti-zero-grau', name: 'Conti Zero Grau', description: 'Cerveja com √°lcool', price: 3.00 },
                { id: 'eisenbah-pilsen', name: 'Eisenbah Pilsen', description: 'Cerveja premium lata', price: 5.00 },
                { id: 'eisenbah-pilsen-long', name: 'Eisenbah Pilsen Long Neck', description: 'Cerveja premium', price: 7.50 },
                { id: 'imperio-zero', name: 'Imp√©rio Zero', description: 'Imp√©rio Zero Lata', price: 5.50 },
                { id: 'imperio-ultra-long', name: 'Imp√©rio Ultra Long Neck', description: 'Cerveja sem gl√∫ten', price: 6.50 },
                { id: 'imperio-lager-long', name: 'Imp√©rio Lager Long Neck', description: 'Imp√©rio premium', price: 7.50 },
                { id: 'heineken-zero', name: 'Heineken Zero', description: 'Cerveja importada lata', price: 6.50 },
                { id: 'heineken-zero-long', name: 'Heineken Zero Long Neck', description: 'Cerveja zero importada premium', price: 8.50 }
            ],
            'destilados': [
                { id: 'tequila', name: 'Tequila', description: 'Destilado mexicano', price: 23.00 },
                { id: 'pinga-51', name: 'Pinga 51', description: 'Cacha√ßa brasileira', price: 19.00 },
                { id: 'conhaque', name: 'Conhaque', description: 'Destilado envelhecido', price: 19.00 },
                { id: 'dimel', name: 'Dimel', description: 'Licor italiano', price: 30.00 },
                { id: 'campari', name: 'Campari', description: 'Bitter italiano', price: 65.00 },
                { id: 'askov-pura', name: 'Askov Pura', description: 'Vodka brasileira pura', price: 20.00 },
                { id: 'beats-long', name: 'Beats Long', description: 'Bebida Sense em long neck', price: 9.00 },
                { id: 'smirnoff-ice', name: 'Smirnoff Ice', description: 'Bebida de lim√£o com vodka', price: 10.00 },
                { id: 'velho-barreiro', name: 'Velho Barreiro', description: 'Cacha√ßa tradicional', price: 19.00 },
                { id: 'jack-daniels-dest', name: 'Jack Daniels', description: 'Whiskey americano', price: 200.00 },
                { id: 'white-horse-dest', name: 'White Horse', description: 'Whisky escoc√™s', price: 97.50 },
                { id: 'red-label-dest', name: 'Red Label', description: 'Johnnie Walker', price: 140.00 },
                { id: 'ballantines-dest', name: 'Ballantines', description: 'Whisky escoc√™s', price: 135.00 },
                { id: 'smirnoff-1l', name: 'Smirnoff 1L', description: 'Vodka premium 1 litro', price: 56.00 },
                { id: 'canelinha', name: 'Canelinha', description: 'Canelinha da Rocha', price: 25.00 },
                { id: 'dom-bosco', name: 'Dom Bosco', description: 'Vinho brasileiro', price: 20.00 },
                { id: 'chapinha', name: 'Chapinha', description: 'Vinho brasileiro', price: 15.00 },
                { id: 'pergola', name: 'P√©rgola', description: 'Licor premium', price: 35.00 },
                { id: 'dom-feliciano', name: 'Dom Feliciano', description: 'Licor ga√∫cho', price: 20.00 },
                { id: 'cantinho-do-valle', name: 'Cantinho do Valle', description: 'Bebida ready to drink', price: 8.00 },
                { id: 'stempel-355ml', name: 'Stempel 355ml', description: 'Cerveja artesanal em garrafa', price: 8.00 },
                { id: 'stempel-600ml', name: 'Stempel 600ml', description: 'Cerveja artesanal 600ml', price: 12.00 },
                { id: 'askov-ice', name: 'Askov Ice', description: 'Ice de vodka', price: 12.00, requiresFlavorSelection: true, flavorType: 'ice_askov' },
                { id: '51-ice', name: '51 Ice', description: 'Ice de cacha√ßa', price: 10.00, requiresFlavorSelection: true, flavorType: 'ice_51' },
                { id: 'ice-leev', name: 'Ice Leev', description: 'Ice de vodka', price: 12.00, requiresFlavorSelection: true, flavorType: 'ice_leev' },
                { id: 'beats-lata', name: 'Beats Lata', description: 'Energ√©tico', price: 9.00, requiresFlavorSelection: true, flavorType: 'beats' },
                { id: 'smirnoff-long', name: 'Smirnoff Long', description: 'Ice de vodka premium', price: 15.00, requiresFlavorSelection: true, flavorType: 'smirnoff_long' }
    ],
            ],
            'aguas': [
                { id: 'agua-500ml', name: '√Ågua 500ml', description: '√Ågua mineral', price: 3.00 },
                { id: 'agua-1.5l', name: '√Ågua 1,5L', description: '√Ågua fam√≠lia', price: 6.00 },
                { id: 'agua-gas-500ml', name: '√Ågua G√°s 500ml', description: '√Ågua com g√°s', price: 3.50 },
                { id: 'h2o-500ml', name: 'H2O 500ml', description: '√Ågua premium', price: 5.00, requiresFlavorSelection: true, flavorType: 'h2o_sabores' },
                { id: 'gatorade', name: 'Gatorade', description: 'Isot√¥nico', price: 8.00 }
            ],
            'refri-latas': [
                { id: 'coca-cola-lata', name: 'Coca Cola', description: 'Refrigerante', price: 4.50 },
                { id: 'guarana-antarctica', name: 'Guaran√° Antarctica', description: 'Refrigerante', price: 4.50 },
                { id: 'fanta-laranja', name: 'Fanta Laranja', description: 'Refrigerante', price: 4.50 },
                { id: 'pepsi-black', name: 'Pepsi Black', description: 'Refrigerante', price: 4.50 },
                { id: 'coca-zero-lata', name: 'Coca Cola Zero', description: 'Refrigerante zero', price: 4.50 },
                { id: 'guarana-antarctica-zero', name: 'Guaran√° Antarctica Zero', description: 'Refrigerante zero lata', price: 4.50 },
                { id: 'fanta-laranja-zero', name: 'Fanta Laranja Zero', description: 'Refrigerante de laranja lata', price: 4.50 },
                { id: 'fanta-uva', name: 'Fanta Uva', description: 'Refrigerante de uva lata', price: 4.50 },
                { id: 'sprite', name: 'Sprite', description: 'Refrigerante de lim√£o lata', price: 4.50 },
                { id: 'sprite-zero', name: 'Sprite Zero', description: 'Refrigerante de lim√£o zero lata', price: 4.50 },
                { id: 'schwepps', name: 'Schwepps', description: 'Refrigerante c√≠trico lata', price: 4.50 },
                { id: 'fys-guarana', name: 'Fys Guaran√°', description: 'Refrigerante de guaran√°', price: 4.50 },
                { id: 'fys-laranja-pera', name: 'Fys Laranja P√™ra', description: 'Refrigerante de laranja', price: 4.50 },
                { id: 'fys-limao-siciliano', name: 'Fys Lim√£o Siciliano', description: 'Refrigerante de lim√£o', price: 4.50 }
                
            ],
            'refri-pet': [
                { id: 'coca-2l', name: 'Coca-Cola 2L', description: 'Refrigerante fam√≠lia', price: 13.00 },
                { id: 'sprite-2l', name: 'Sprite 2L', description: 'Refrigerante c√≠trico', price: 11.00 },
                { id: 'fanta-laranja-2l', name: 'Fanta Laranja 2L', description: 'Refrigerante laranja', price: 11.00 },
                { id: 'coca-mini', name: 'Coca Mini', description: 'Coca-Cola pequena', price: 3.00 },
                { id: 'conq-mini', name: 'Conq. Mini', description: 'Conquista mini', price: 2.50 },
                { id: 'coca-600ml', name: 'Coca 600ml', description: 'Coca-Cola 600ml', price: 7.00 },
                { id: 'coca-600ml-zero', name: 'Coca 600ml Zero', description: 'Coca-Cola Zero 600ml', price: 7.00 },
                { id: 'coca-1l', name: 'Coca-Cola 1L', description: 'Coca-Cola 1 litro', price: 9.00 },
                { id: 'coca-1l-zero', name: 'Coca-Cola 1L Zero', description: 'Coca-Cola Zero 1 litro', price: 9.00 },
                { id: 'sprite-600ml', name: 'Sprite 600ml', description: 'Sprite 600ml', price: 6.00 },
                { id: 'schwepps-1.5l', name: 'Schwepps 1,5L', description: 'Refrigerante c√≠trico premium', price: 10.50 },
                { id: 'guarana-2l', name: 'Ant√°rctica 2L', description: 'Guaran√° Antarctica 2 litros', price: 12.00 },
                { id: 'guarana-2l-zero', name: 'Ant√°rctica 2L Zero', description: 'Guaran√° Antarctica Zero 2 litros', price: 12.00 },
                { id: 'guarana-1l', name: 'Ant√°rctica 1L', description: 'Guaran√° Antarctica 1 litro', price: 9.00 },
                { id: 'conquista-2l', name: 'Conquista 2L', description: 'Guaran√° Conquista 2 litros', price: 8.50 },
                { id: 'quinze-2l', name: 'Quinze 2L', description: 'Guaran√° Quinze 2 litros', price: 7.00 },
                { id: 'conti-2l', name: 'Conti 2L', description: 'Refrigerante Cola 2 litros', price: 8.50 },
                { id: 'guarana-mini', name: 'Guaran√° Mini', description: 'Guaran√° Antarctica individual', price: 3.00 },
                { id: 'coca-zero-2l', name: 'Coca-Cola Zero 2L', description: 'Refrigerante fam√≠lia sem a√ßucar', price: 13.00 },
                { id: 'conquista-laranja-2l', name: 'Conquista Laranja 2L', description: 'Refrigerante sabor laranja', price: 8.50 },
                { id: 'conquista-limao-2l', name: 'Conquista Lim√£o 2L', description: 'Refrigerante sabor lim√£o', price: 8.50 },
                { id: 'fanta-uva-2l', name: 'Fanta Uva 2L', description: 'Refrigerante sabor uva', price: 11.00 },
                { id: 'sprite-zero-2l', name: 'Sprite Zero 2L', description: 'Refrigerante de lim√£o zero a√ßucar', price: 11.00 },
                { id: 'pepsi-black-2l', name: 'Pepsi Black 2L', description: 'Refrigerante de cola zero', price: 11.00 }
            ],
            'sucos': [
                { id: 'del-valle-1l', name: 'Del Valle 1L', description: 'Suco de caixinha', price: 12.00, requiresFlavorSelection: true, flavorType: 'suco_delvalle' },
                { id: 'prats-300ml-laranja', name: 'Prats 300ml', description: 'Suco de laranja', price: 6.00 },
                { id: 'kapo', name: 'Kapo', description: 'Suco em p√≥', price: 4.00, requiresFlavorSelection: true, flavorType: 'suco_kapo' },
                { id: 'life-900ml', name: 'Life 900ml', description: 'Suco premium', price: 14.00, requiresFlavorSelection: true, flavorType: 'suco_life' }
            ],
            'energeticos': [
                { id: 'big-power-2l', name: 'Big Power 2L', description: 'Energ√©tico', price: 13.00 },
                { id: 'monster-473ml', name: 'Monster 473ml', description: 'Energ√©tico', price: 12.00, requiresFlavorSelection: true, flavorType: 'energetico_monster' },
                { id: 'red-bull-250ml', name: 'Red Bull', description: 'Energ√©tico', price: 14.00 },
                { id: 'bally-2l', name: 'Bally 2L', description: 'Energ√©tico', price: 15.00, requiresFlavorSelection: true, flavorType: 'energetico_bally' }
            ],
            'gelo-carvao': [
                { id: 'gelo-saborizado', name: 'Gelo Saborizado', description: 'Gelo com sabor', price: 3.00, requiresFlavorSelection: true, flavorType: 'gelo_sabores' },
                { id: 'carvao-3kg', name: 'Carv√£o 3kg', description: 'Carv√£o', price: 20.00 },
                { id: 'gelo-4.5kg', name: 'Gelo 4,5Kg', description: 'Gelo', price: 11.00 }
            ],
            'salgadinhos': [
                { id: 'salgadinho-bacon', name: 'Salgadinho de Bacon', description: 'Salgadinho', price: 4.50 },
                { id: 'amendoim-descascado', name: 'Amendoim Descascado', description: 'Salgado', price: 4.50 },
                { id: 'amendoim-com-casca', name: 'Amendoim com Casca', description: 'Salgado', price: 4.50 },
                { id: 'cheetos-160g', name: 'Cheetos 160g', description: 'Salgadinho grande', price: 17.00 },
                { id: 'cheetos-35g', name: 'Cheetos 35g', description: 'Salgadinho pequeno', price: 6.00 },
                { id: 'doritos-32g', name: 'Doritos 32g', description: 'Doritos pequeno', price: 7.00 },
                { id: 'doritos-120g', name: 'Doritos 120g', description: 'Doritos m√©dio', price: 17.00 },
                { id: 'fandangos-35g', name: 'Fandangos 35g', description: 'Salgadinho pequeno', price: 6.00 },
                { id: 'fandangos-160g', name: 'Fandangos 160g', description: 'Salgadinho grande', price: 17.00 }
            ],
            'doces': [
                { id: 'pacoca-caseira', name: 'Pa√ßoca Caseira', description: 'Doce de amendoim', price: 3.50 },
                { id: 'pacoca-rolha', name: 'Pa√ßoca de Rolha', description: 'Doce de amendoim', price: 3.50 },
                { id: 'kit-kat', name: 'Kit Kat', description: 'Chocolate', price: 6.00 }
            ]
        };

      // ============================================
// CAT√ÅLOGO DE SABORES (ATUALIZADO)
// ============================================
const FLAVOR_CATALOG = {
    'whisky_oldstar': ['Old Star Tradicional', 'Old Star Ma√ß√£-Verde'],
    'whisky_jack': ['Jack Tradicional', 'Jack Mel', 'Jack Ma√ß√£-Verde'],
    'whisky_sem_sabor': ['Tradicional'],
    'gin_sabores': ['Tropical', 'Melancia', 'Morango', 'Ma√ß√£-Verde'],
    'corote_sabores': ['Morango', 'Mel√¢ncia', 'Maracuj√°', 'P√™ssego', 'Blueberry', 'Lim√£o', 'Canelinha'],
    'vodka_sabores': ['Frutas Vermelhas', 'Maracuj√°', 'Frutas Roxas', 'Kiwi', 'P√™ssego', 'Lim√£o', 'Blueberry'],
    'ice_askov': ['Maracuj√°', 'Lim√£o', 'Frutas Vermelhas', 'Pina Colada'],
    'ice_51': ['Lim√£o', 'Balada'], // NOVO
    'ice_leev': ['Morango', 'Lim√£o', 'Mel√¢ncia', 'Maracuj√°', 'Abacaxi com Hortel√£', 'Ma√ß√£-Verde'],
    'beats': ['Sense', 'GT', 'Red Mix', 'Green Mix'],
    'smirnoff_long': ['Ma√ß√£ Verde', 'Tropical'], // NOVO
    'h2o_sabores': ['Lim√£o', 'Limoneto'],
    'suco_delvalle': ['Laranja', 'Manga', 'Maracuj√°', 'Caju', 'Uva', 'P√™ssego'],
    'suco_kapo': ['Uva', 'Morango', 'Maracuj√°', 'Laranja'],
    'suco_life': ['Uva', 'Laranja'],
    'energetico_monster': ['Tradicional', 'Zero', 'Uva', 'Mango Loco', 'Melancia', 'Cereja', 'P√™ssego'],
    'energetico_bally': ['Tradicional', 'Morango/P√™ssego', 'Melancia', 'Tropical'],
    'gelo_sabores': ['Melancia', 'Morango', 'Lim√£o', 'C√¥co', 'Ma√ß√£-Verde', 'Abacaxi/Hortel√£', 'Maracuj√°', 'Laranja']
};
        
        const FLAVOR_TYPES = {
            'whisky_oldstar': 'Old Star',
            'whisky_jack': 'Jack Daniels',
            'whisky_sem_sabor': 'Whisky',
            'gin_sabores': 'Gin',
            'corote_sabores': 'Corote',
            'vodka_sabores': 'Vodka',
            'ice_askov': 'Askov Ice',
            'ice_leev': 'Ice Leev',
            'beats': 'Beats',
            'h2o_sabores': 'H2O',
            'suco_delvalle': 'Suco Del Valle',
            'suco_kapo': 'Kapo',
            'suco_life': 'Life',
            'energetico_monster': 'Monster',
            'energetico_bally': 'Bally',
            'gelo_sabores': 'Gelo'
            'smirnoff_long': 'Smirnoff Long', // NOVO
            'ice_51': '51 Ice', // NOVO
        };

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        const state = {
            cart: [],
            currentCategory: 'drinks-whisky',
            deliveryType: 'pickup',
            paymentMethod: 'pix',
            paymentConfirmed: false,
            paymentProcessing: false,
            currentOrderId: null,
            pendingProduct: null,
            pendingFlavors: {},
            currentFlavorStep: null,
            currentButton: null,
            adminAuthenticated: false,
            adminToken: null,
            productAvailability: {},
            flavorAvailability: {},
            ageVerified: false,
            backendOnline: null,
            offlineSince: null,
            syncQueue: [],
            mpInstance: null,
            deliveryDistance: null,
            deliveryFee: 0,
            preferenceId: null,
            paymentStatus: null,
            paymentCheckInterval: null,
            // NOVO: Flag para controlar se j√° enviou WhatsApp
            whatsappSent: false,
            // NOVO: Estado para busca
            searchActive: false,
            searchQuery: ''
        };

        // ============================================
        // NOVAS FUN√á√ïES DE BUSCA
        // ============================================
        
        // Fun√ß√£o para buscar produtos em todas as categorias
        function searchProducts(query) {
            if (!query || query.trim().length < 2) {
                return [];
            }
            
            const searchTerm = query.toLowerCase().trim();
            const results = [];
            
            // Percorre todas as categorias
            Object.keys(products).forEach(categoryId => {
                products[categoryId].forEach(product => {
                    // Verifica se o nome do produto cont√©m o termo de busca
                    if (product.name.toLowerCase().includes(searchTerm) || 
                        product.description.toLowerCase().includes(searchTerm)) {
                        results.push({
                            ...product,
                            categoryId: categoryId // Adiciona a categoria para refer√™ncia
                        });
                    }
                });
            });
            
            return results;
        }

        // Fun√ß√£o principal de busca chamada no input
        function handleSearch(query) {
            state.searchQuery = query;
            
            if (!query || query.trim().length < 2) {
                // Se busca vazia ou muito curta, volta para a categoria atual
                state.searchActive = false;
                document.getElementById('searchResultsInfo').style.display = 'none';
                showCategory(state.currentCategory);
                return;
            }
            
            const results = searchProducts(query);
            
            if (results.length > 0) {
                state.searchActive = true;
                displaySearchResults(results, query);
            } else {
                // Nenhum resultado encontrado
                state.searchActive = true;
                displayNoResults(query);
            }
        }

        // Exibe os resultados da busca
        function displaySearchResults(results, query) {
            const grid = document.getElementById('productsGrid');
            const searchInfo = document.getElementById('searchResultsInfo');
            
            grid.innerHTML = '';
            
            results.forEach(product => {
                const available = isProductAvailable(product.id);
                const hasFlavors = product.requiresFlavorSelection || false;
                
                const card = document.createElement('div');
                card.className = `product-card ${!available ? 'unavailable' : ''} ${hasFlavors ? 'with-flavors' : ''}`;
                card.setAttribute('data-product-id', product.id);
                
                let btnText = 'üõí Adicionar';
                let btnClass = 'add-to-cart-btn';
                if (!available) {
                    btnText = '‚ùå Indispon√≠vel';
                } else if (hasFlavors) {
                    btnText = '‚ö° Sabores';
                    btnClass += ' has-flavors';
                }
                
                // Adiciona badge da categoria
                const categoryNames = {
                    'drinks-whisky': 'ü•É Whisky',
                    'drinks-gin': 'üç∏ Gin',
                    'drinks-vodka': 'üç∏ Vodka',
                    'drinks-vinho': 'üç∑ Vinho',
                    'cervejas': 'üç∫ Cerveja',
                    'destilados': 'ü•É Destilado',
                    'aguas': 'üíß √Ågua',
                    'refri-latas': 'ü•§ Refri Lata',
                    'refri-pet': 'ü•§ Refri PET',
                    'sucos': 'üßÉ Suco',
                    'energeticos': '‚ö° Energ√©tico',
                    'gelo-carvao': 'üßä Gelo/Carv√£o',
                    'salgadinhos': 'ü•® Salgado',
                    'doces': 'üç¨ Doce'
                };
                
                card.innerHTML = `
                    ${hasFlavors ? '<div class="flavor-badge">‚ö°</div>' : ''}
                    <div style="position: absolute; top: 12px; left: 12px; background: rgba(77, 150, 255, 0.2); padding: 4px 8px; border-radius: 12px; font-size: 11px; color: var(--secondary); border: 1px solid var(--secondary);">
                        ${categoryNames[product.categoryId] || product.categoryId}
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-info">${product.description}</div>
                    <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                    <button class="${btnClass}" onclick="handleAddToCart('${product.id}', this)" ${!available ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                `;
                grid.appendChild(card);
            });
            
            // Mostra informa√ß√µes da busca
            searchInfo.style.display = 'flex';
            searchInfo.innerHTML = `
                <span>üîç Encontrados ${results.length} produto(s) para "${query}"</span>
                <button class="clear-search-btn" onclick="clearSearch()">Limpar busca ‚úï</button>
            `;
            
            // Esconde as categorias durante a busca
            document.getElementById('categoriesGrid').style.display = 'none';
        }

        // Exibe mensagem quando n√£o h√° resultados
        function displayNoResults(query) {
            const grid = document.getElementById('productsGrid');
            const searchInfo = document.getElementById('searchResultsInfo');
            
            grid.innerHTML = `
                <div style="text-align: center; color: #aaa; padding: 50px; grid-column: 1/-1;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üòï</div>
                    <div style="font-size: 18px; margin-bottom: 10px;">Nenhum produto encontrado para "${query}"</div>
                    <div style="font-size: 14px; color: #666;">Tente buscar por outro termo</div>
                </div>
            `;
            
            searchInfo.style.display = 'flex';
            searchInfo.innerHTML = `
                <span>üîç Nenhum resultado para "${query}"</span>
                <button class="clear-search-btn" onclick="clearSearch()">Limpar busca ‚úï</button>
            `;
            
            document.getElementById('categoriesGrid').style.display = 'none';
        }

        // Limpa a busca e volta para a categoria atual
        function clearSearch() {
            state.searchActive = false;
            state.searchQuery = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResultsInfo').style.display = 'none';
            document.getElementById('categoriesGrid').style.display = 'grid';
            showCategory(state.currentCategory);
        }

        // ============================================
        // CARREGAR CONFIGURA√á√ÉO SEGURA DO BACKEND
        // ============================================
        async function loadSecureConfig() {
            try {
                const response = await fetch(`${CONFIG.backendUrl}/api/config`, {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (response.ok) {
                    const config = await response.json();
                    CONFIG = { ...CONFIG, ...config, adminPassword: null };
                    console.log('‚úÖ Configura√ß√£o carregada do backend');
                    
                    if (CONFIG.mercadoPago?.publicKey) {
                        initMercadoPago();
                    }
                    return true;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Backend offline, usando configura√ß√£o padr√£o');
                showNotification('‚ö†Ô∏è Servidor offline. Pagamentos podem n√£o funcionar.', 'warning');
                return false;
            }
        }

        // ============================================
        // INICIALIZAR MERCADO PAGO
        // ============================================
        function initMercadoPago() {
            try {
                if (window.MercadoPago && CONFIG.mercadoPago?.publicKey) {
                    state.mpInstance = new MercadoPago(CONFIG.mercadoPago.publicKey, { 
                        locale: 'pt-BR',
                        advancedFraudPrevention: true
                    });
                    console.log('‚úÖ Mercado Pago SDK inicializado em modo produ√ß√£o');
                } else {
                    console.warn('‚ö†Ô∏è Mercado Pago n√£o inicializado: chave p√∫blica ausente');
                }
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Mercado Pago:', error);
            }
        }

        // ============================================
        // VERIFICA√á√ÉO DE IDADE
        // ============================================
        function initAgeVerification() {
            state.ageVerified = true;
            
            const hasConfirmed = localStorage.getItem('bebcom_age_verified');
            const verifiedTime = localStorage.getItem('bebcom_age_verified_time');
            
            if (hasConfirmed === 'true' && verifiedTime) {
                const hoursSinceVerification = (Date.now() - parseInt(verifiedTime)) / (1000 * 60 * 60);
                if (hoursSinceVerification < 24) {
                    document.getElementById('ageVerificationModal').style.display = 'none';
                    document.body.style.overflow = 'auto';
                    initAfterAgeVerification();
                    return;
                }
            }
            
            const modal = document.getElementById('ageVerificationModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            const checkbox = document.getElementById('ageConfirmationCheckbox');
            const enterBtn = document.getElementById('enterSiteButton');
            
            checkbox.addEventListener('change', function() { enterBtn.disabled = !this.checked; });
            
            enterBtn.addEventListener('click', async function() {
                if (!checkbox.checked) return;
                localStorage.setItem('bebcom_age_verified', 'true');
                localStorage.setItem('bebcom_age_verified_time', Date.now().toString());
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                initAfterAgeVerification();
            });
            
            setTimeout(() => {
                if (document.getElementById('ageVerificationModal').style.display !== 'flex') {
                    initAfterAgeVerification();
                }
            }, 100);
        }

        // ============================================
        // INICIALIZA√á√ÉO P√ìS-VERIFICA√á√ÉO DE IDADE
        // ============================================
        async function initAfterAgeVerification() {
            console.log('‚úÖ Inicializando interface...');
            
            recoverPendingOrder();
            
            await loadAvailability();
            loadCart();
            showCategory('drinks-whisky');
            setupEventListeners();
            setupPhoneMask();
            setupCpfMask();
            selectDeliveryType('pickup');
            
            // NOVO: Carregar dados salvos do cliente se existirem
            loadSavedCustomerData();
            
            setInterval(checkBackendHealth, 300000);
            checkForPaymentReturn();
        }

        // ============================================
        // NOVO: SALVAR DADOS DO CLIENTE ANTES DO PAGAMENTO
        // ============================================
        function saveCustomerDataBeforePayment() {
            const customerData = {
                name: document.getElementById('customerName').value.trim(),
                phone: document.getElementById('customerPhone').value.trim(),
                email: document.getElementById('customerEmail').value.trim(),
                cpf: document.getElementById('customerCpf').value.trim(),
                deliveryType: state.deliveryType,
                deliveryDistance: state.deliveryDistance,
                deliveryFee: state.deliveryFee,
                address: {
                    street: document.getElementById('street')?.value.trim() || '',
                    number: document.getElementById('number')?.value.trim() || '',
                    neighborhood: document.getElementById('neighborhood')?.value.trim() || '',
                    city: document.getElementById('city')?.value.trim() || 'Bauru',
                    complement: document.getElementById('addressComplement')?.value.trim() || ''
                }
            };
            
            sessionStorage.setItem('bebcom_customer_data', JSON.stringify({
                data: customerData,
                timestamp: Date.now()
            }));
            
            console.log('‚úÖ Dados do cliente salvos antes do pagamento');
        }

        // ============================================
        // NOVO: CARREGAR DADOS SALVOS DO CLIENTE
        // ============================================
        function loadSavedCustomerData() {
            try {
                const saved = sessionStorage.getItem('bebcom_customer_data');
                if (!saved) return;
                
                const { data, timestamp } = JSON.parse(saved);
                
                // Verificar se os dados n√£o expiraram (1 hora)
                if (Date.now() - timestamp > 60 * 60 * 1000) {
                    sessionStorage.removeItem('bebcom_customer_data');
                    return;
                }
                
                console.log('üîÑ Recuperando dados salvos do cliente');
                
                // Preencher campos
                document.getElementById('customerName').value = data.name || '';
                document.getElementById('customerPhone').value = data.phone || '';
                document.getElementById('customerEmail').value = data.email || '';
                document.getElementById('customerCpf').value = data.cpf || '';
                
                if (data.deliveryType === 'delivery') {
                    selectDeliveryType('delivery');
                    
                    // Restaurar endere√ßo
                    if (data.address) {
                        document.getElementById('street').value = data.address.street || '';
                        document.getElementById('number').value = data.address.number || '';
                        document.getElementById('neighborhood').value = data.address.neighborhood || '';
                        document.getElementById('city').value = data.address.city || 'Bauru';
                        document.getElementById('addressComplement').value = data.address.complement || '';
                    }
                    
                    // Restaurar dados de entrega
                    if (data.deliveryDistance && data.deliveryFee) {
                        state.deliveryDistance = data.deliveryDistance;
                        state.deliveryFee = data.deliveryFee;
                        
                        const statusEl = document.getElementById('deliveryCalculationStatus');
                        statusEl.innerHTML = `‚úÖ Dist√¢ncia: ${data.deliveryDistance.toFixed(1)}km - Taxa: R$ ${data.deliveryFee.toFixed(2)}`;
                        
                        updateCart();
                    }
                }
                
                validateForm();
                
            } catch (e) {
                console.warn('Erro ao carregar dados salvos:', e);
                sessionStorage.removeItem('bebcom_customer_data');
            }
        }

        // ============================================
        // FUN√á√ÉO PARA RECUPERAR PEDIDO PENDENTE
        // ============================================
        function recoverPendingOrder() {
            try {
                const saved = sessionStorage.getItem('bebcom_last_order');
                if (!saved) return;
                
                const order = JSON.parse(saved);
                
                if (order.confirmed && (Date.now() - order.timestamp < 60 * 60 * 1000)) {
                    console.log('üîÑ Recuperando pedido pendente:', order);
                    
                    state.currentOrderId = order.orderId;
                    state.paymentConfirmed = true;
                    
                    const statusDiv = document.getElementById('paymentStatus');
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'payment-status success';
                    statusDiv.innerHTML = '‚úÖ Pagamento aprovado! Seu pedido est√° confirmado.';
                    
                    document.getElementById('payButton').style.display = 'none';
                    enableWhatsAppButton();
                } else {
                    sessionStorage.removeItem('bebcom_last_order');
                }
            } catch (e) {
                console.warn('Erro ao recuperar pedido:', e);
                sessionStorage.removeItem('bebcom_last_order');
            }
        }

        // ============================================
        // VERIFICAR RETORNO DE PAGAMENTO
        // ============================================
        function checkForPaymentReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentId = urlParams.get('payment_id');
            const status = urlParams.get('status');
            const orderId = urlParams.get('order_id');
            const collectionId = urlParams.get('collection_id');
            const preferenceId = urlParams.get('preference_id');
            
            console.log('üîç Par√¢metros de retorno:', { paymentId, status, orderId, collectionId, preferenceId });
            
            if ((paymentId || collectionId) && orderId) {
                const actualPaymentId = paymentId || collectionId;
                
                const statusDiv = document.getElementById('paymentStatus');
                statusDiv.style.display = 'block';
                statusDiv.className = 'payment-status info';
                statusDiv.innerHTML = 'üîÑ Verificando pagamento...';
                
                if (status === 'approved') {
                    confirmPaymentSuccess(orderId, actualPaymentId);
                } else {
                    checkPaymentStatus(orderId, actualPaymentId);
                }
                
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ============================================
        // FUN√á√ÉO PARA CONFIRMAR PAGAMENTO COM SUCESSO
        // ============================================
        function confirmPaymentSuccess(orderId, paymentId) {
            console.log('‚úÖ Pagamento confirmado!', { orderId, paymentId });
            
            state.currentOrderId = orderId;
            state.paymentConfirmed = true;
            
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'payment-status success';
            statusDiv.innerHTML = '‚úÖ Pagamento aprovado! Seu pedido est√° confirmado.';
            
            document.getElementById('payButton').style.display = 'none';
            enableWhatsAppButton();
            
            sessionStorage.setItem('bebcom_last_order', JSON.stringify({
                orderId: orderId,
                paymentId: paymentId,
                confirmed: true,
                timestamp: Date.now()
            }));
            
            // NOVO: Resetar flag de WhatsApp enviado
            state.whatsappSent = false;
        }

        // ============================================
        // FUN√á√ÉO PARA VERIFICAR STATUS NO BACKEND
        // ============================================
        async function checkPaymentStatus(orderId, paymentId) {
            try {
                console.log('üîÑ Verificando status do pagamento...');
                
                const response = await fetch(`${CONFIG.backendUrl}/api/payment-status/${orderId}`);
                const data = await response.json();
                
                console.log('üì• Status do pedido:', data);
                
                if (data.success && data.status === 'approved') {
                    confirmPaymentSuccess(orderId, paymentId);
                } else {
                    setTimeout(() => checkPaymentStatus(orderId, paymentId), 3000);
                    
                    const statusDiv = document.getElementById('paymentStatus');
                    statusDiv.innerHTML = '‚è≥ Pagamento processando. Aguarde confirma√ß√£o...';
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
                setTimeout(() => checkPaymentStatus(orderId, paymentId), 5000);
            }
        }

        // ============================================
        // STORAGE MANAGEMENT
        // ============================================
        function initStorage() {
            if (!localStorage.getItem('bebcom_product_availability')) {
                const defaultAvailability = {};
                Object.keys(products).forEach(cat => {
                    products[cat].forEach(p => { defaultAvailability[p.id] = true; });
                });
                localStorage.setItem('bebcom_product_availability', JSON.stringify(defaultAvailability));
                state.productAvailability = defaultAvailability;
            } else {
                state.productAvailability = JSON.parse(localStorage.getItem('bebcom_product_availability'));
            }
            
            if (!localStorage.getItem('bebcom_flavor_availability')) {
                const defaultFlavors = {};
                Object.keys(FLAVOR_CATALOG).forEach(type => {
                    FLAVOR_CATALOG[type].forEach(flavor => {
                        defaultFlavors[`${type}_${flavor}`] = true;
                    });
                });
                localStorage.setItem('bebcom_flavor_availability', JSON.stringify(defaultFlavors));
                state.flavorAvailability = defaultFlavors;
            } else {
                state.flavorAvailability = JSON.parse(localStorage.getItem('bebcom_flavor_availability'));
            }
        }

        // ============================================
        // BACKEND HEALTH CHECK
        // ============================================
        async function checkBackendHealth() {
            if (!CONFIG.backendUrl) return false;
            try {
                const response = await fetch(`${CONFIG.backendUrl}/health`, {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                if (response.ok) {
                    state.backendOnline = true;
                    state.offlineSince = null;
                    console.log('‚úÖ Backend online');
                    return true;
                }
            } catch (error) {
                state.backendOnline = false;
                state.offlineSince = state.offlineSince || Date.now();
                console.warn('‚ö†Ô∏è Backend offline - Modo local');
                return false;
            }
        }

        // ============================================
        // CARREGAR DISPONIBILIDADE
        // ============================================
        async function loadAvailability() {
            try {
                if (CONFIG.backendUrl) {
                    await checkBackendHealth();
                    
                    if (state.backendOnline) {
                        console.log('üì° Buscando disponibilidade do servidor...');
                        
                        const [productsRes, flavorsRes] = await Promise.all([
                            fetch(`${CONFIG.backendUrl}/api/product-availability`),
                            fetch(`${CONFIG.backendUrl}/api/flavor-availability`)
                        ]);
                        
                        if (productsRes.ok) {
                            const productData = await productsRes.json();
                            if (productData.success && productData.productAvailability) {
                                state.productAvailability = productData.productAvailability;
                                localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                                console.log('‚úÖ Produtos carregados do servidor');
                            }
                        }
                        
                        if (flavorsRes.ok) {
                            const flavorData = await flavorsRes.json();
                            if (flavorData.success && flavorData.flavorAvailability) {
                                state.flavorAvailability = flavorData.flavorAvailability;
                                localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                                console.log('‚úÖ Sabores carregados do servidor');
                            }
                        }
                        
                        updateMenuAvailability();
                        
                        if (document.getElementById('adminMain').style.display === 'block') {
                            loadAdminProducts();
                        }
                        
                        return;
                    }
                }
                
                console.log('‚ö†Ô∏è Servidor offline, usando dados locais');
                initStorage();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar disponibilidade:', error);
                initStorage();
            }
        }

        // ============================================
        // FUN√á√ïES DE PRODUTO
        // ============================================
        function isProductAvailable(productId) {
            return state.productAvailability[productId] !== false;
        }

        function isFlavorAvailable(flavorType, flavorName) {
            const key = `${flavorType}_${flavorName}`;
            return state.flavorAvailability[key] !== false;
        }

        function findProductById(productId) {
            for (const cat in products) {
                const found = products[cat].find(p => p.id === productId);
                if (found) return found;
            }
            return null;
        }

        // ============================================
        // EXIBIR CATEGORIA (MODIFICADO PARA RESPEITAR A BUSCA)
        // ============================================
        function showCategory(categoryId) {
            // Se a busca estiver ativa, n√£o muda a visualiza√ß√£o
            if (state.searchActive) {
                state.currentCategory = categoryId; // Apenas atualiza a refer√™ncia
                return;
            }
            
            state.currentCategory = categoryId;
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            const categoryProducts = products[categoryId] || [];
            if (categoryProducts.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #aaa; padding: 50px;">Nenhum produto nesta categoria</div>';
                return;
            }
            
            categoryProducts.forEach(product => {
                const available = isProductAvailable(product.id);
                const hasFlavors = product.requiresFlavorSelection || false;
                const card = document.createElement('div');
                card.className = `product-card ${!available ? 'unavailable' : ''} ${hasFlavors ? 'with-flavors' : ''}`;
                card.setAttribute('data-product-id', product.id);
                
                let btnText = 'üõí Adicionar';
                let btnClass = 'add-to-cart-btn';
                if (!available) {
                    btnText = '‚ùå Indispon√≠vel';
                } else if (hasFlavors) {
                    btnText = '‚ö° Sabores';
                    btnClass += ' has-flavors';
                }
                
                card.innerHTML = `
                    ${hasFlavors ? '<div class="flavor-badge">‚ö°</div>' : ''}
                    <div class="product-name">${product.name}</div>
                    <div class="product-info">${product.description}</div>
                    <div class="product-price">R$ ${product.price.toFixed(2)}</div>
                    <button class="${btnClass}" onclick="handleAddToCart('${product.id}', this)" ${!available ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // ============================================
        // ADICIONAR AO CARRINHO
        // ============================================
        function handleAddToCart(productId, button) {
            const product = findProductById(productId);
            if (!product) return;
            if (!isProductAvailable(productId)) {
                showNotification('‚ùå Produto indispon√≠vel', 'error');
                return;
            }
            if (product.requiresFlavorSelection) {
                state.pendingProduct = product;
                state.pendingFlavors = {};
                state.currentFlavorStep = 'primary';
                state.currentButton = button;

                const flavorType = product.flavorType || 'whisky_sem_sabor';
                const flavors = FLAVOR_CATALOG[flavorType] || [];
                const hasAvailable = flavors.some(f => isFlavorAvailable(flavorType, f));

                if (!hasAvailable) {
                    showNotification('‚ùå Todos os sabores est√£o indispon√≠veis', 'error');
                    return;
                }

                if (!product.flavorType) {
                    product.flavorType = 'whisky_sem_sabor';
                }

                openFlavorModal(product, 'primary');
            } else {
                addToCartDirect(product, button);
            }
        }

        // ============================================
        // MODAL DE SABORES
        // ============================================
        function openFlavorModal(product, step) {
            const modal = document.getElementById('flavorModal');
            const title = document.getElementById('flavorModalTitle');
            const instruction = document.getElementById('flavorModalInstruction');
            const grid = document.getElementById('flavorsGrid');
            const confirmBtn = document.getElementById('confirmFlavorButton');
            
            grid.innerHTML = '<div style="text-align: center; padding: 30px;">Carregando...</div>';
            
            setTimeout(() => {
                grid.innerHTML = '';
                let flavorType = product.flavorType;
                let flavors = FLAVOR_CATALOG[flavorType] || [];
                
                if (step === 'ice') {
                    flavorType = 'gelo_sabores';
                    flavors = FLAVOR_CATALOG.gelo_sabores || [];
                    title.textContent = 'üßä Escolha o sabor do gelo';
                    instruction.textContent = 'Selecione o sabor do gelo (sem custo)';
                } else {
                    title.textContent = `Escolha o sabor do ${FLAVOR_TYPES[flavorType] || 'produto'}`;
                    instruction.textContent = `Selecione o sabor para ${product.name}`;
                }
                
                if (flavors.length === 0) {
                    grid.innerHTML = '<div style="text-align: center; padding: 30px; color: #dc2626;">Nenhum sabor dispon√≠vel</div>';
                    confirmBtn.disabled = true;
                    return;
                }
                
                let hasAvailable = false;
                flavors.forEach(flavor => {
                    const available = isFlavorAvailable(flavorType, flavor);
                    if (available) hasAvailable = true;
                    const option = document.createElement('div');
                    option.className = `flavor-option ${!available ? 'unavailable' : ''}`;
                    option.textContent = flavor;
                    option.dataset.flavor = flavor;
                    if (available) {
                        option.onclick = function() {
                            document.querySelectorAll('.flavor-option').forEach(el => el.classList.remove('selected'));
                            this.classList.add('selected');
                            if (step === 'primary') state.pendingFlavors.primary = flavor;
                            else if (step === 'ice') state.pendingFlavors.ice = flavor;
                            confirmBtn.disabled = false;
                        };
                    }
                    grid.appendChild(option);
                });
                
                if (!hasAvailable) {
                    instruction.textContent = '‚ö†Ô∏è Todos os sabores est√£o indispon√≠veis';
                    instruction.style.color = '#dc2626';
                }
                confirmBtn.disabled = true;
                modal.style.display = 'flex';
            }, 100);
        }

        function confirmFlavorSelection() {
            if (state.currentFlavorStep === 'primary' && !state.pendingFlavors.primary) {
                showNotification('‚ùå Selecione um sabor', 'error');
                return;
            }
            if (state.currentFlavorStep === 'ice' && !state.pendingFlavors.ice) {
                showNotification('‚ùå Selecione um sabor de gelo', 'error');
                return;
            }
            
            document.getElementById('flavorModal').style.display = 'none';
            
            if (state.currentFlavorStep === 'primary' && state.pendingProduct.nextStep === 'ice') {
                state.currentFlavorStep = 'ice';
                openFlavorModal(state.pendingProduct, 'ice');
            } else {
                addToCartWithFlavors();
            }
        }

        function cancelFlavorSelection() {
            document.getElementById('flavorModal').style.display = 'none';
            state.pendingProduct = null;
            state.pendingFlavors = {};
            state.currentFlavorStep = null;
            state.currentButton = null;
        }

        function addToCartWithFlavors() {
            if (!state.pendingProduct) return;
            const product = state.pendingProduct;
            const flavors = state.pendingFlavors;
            const existing = state.cart.find(item => 
                item.name === product.name && 
                JSON.stringify(item.flavors) === JSON.stringify(flavors)
            );
            
            if (existing) {
                existing.quantity += 1;
            } else {
                state.cart.push({ 
                    name: product.name, 
                    price: product.price, 
                    quantity: 1, 
                    productId: product.id, 
                    flavors: { ...flavors } 
                });
            }
            updateCart(); 
            saveCart();
            
            if (state.currentButton) {
                const original = state.currentButton.innerHTML;
                state.currentButton.innerHTML = '‚úì Adicionado!';
                state.currentButton.classList.add('added');
                setTimeout(() => { 
                    state.currentButton.innerHTML = original; 
                    state.currentButton.classList.remove('added'); 
                }, 1000);
            }
            
            state.pendingProduct = null; 
            state.pendingFlavors = {}; 
            state.currentFlavorStep = null; 
            state.currentButton = null;
            
            showNotification(`‚úÖ ${product.name} adicionado`);
        }

        function addToCartDirect(product, button) {
            const existing = state.cart.find(item => item.name === product.name && !item.flavors);
            if (existing) existing.quantity += 1;
            else state.cart.push({ name: product.name, price: product.price, quantity: 1, productId: product.id });
            updateCart(); saveCart();
            if (button) {
                const original = button.innerHTML;
                button.innerHTML = '‚úì Adicionado!';
                button.classList.add('added');
                setTimeout(() => { button.innerHTML = original; button.classList.remove('added'); }, 1000);
            }
            showNotification(`‚úÖ ${product.name} adicionado`);
        }

        // ============================================
        // FUN√á√ïES DO CARRINHO
        // ============================================
        function updateCart() {
            const cartEl = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('totalAmount');
            const deliveryRow = document.getElementById('deliveryRow');
            const distanceRow = document.getElementById('distanceRow');
            const deliveryFeeEl = document.getElementById('deliveryFee');
            const distanceValueEl = document.getElementById('distanceValue');
            
            let subtotal = 0;
            if (state.cart.length === 0) {
                cartEl.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">Seu carrinho est√° vazio</div>';
                subtotalEl.textContent = '0.00'; totalEl.textContent = '0.00'; 
                validateForm(); 
                return;
            }
            
            cartEl.innerHTML = '';
            state.cart.forEach((item, idx) => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                let itemName = item.name;
                if (item.flavors) {
                    if (item.flavors.primary) itemName += ` (${item.flavors.primary})`;
                    if (item.flavors.ice) itemName += ` - Gelo: ${item.flavors.ice}`;
                }
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div><strong>${itemName}</strong><br><small>R$ ${item.price.toFixed(2)}</small></div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="updateQuantity(${idx}, -1)" class="quantity-btn">-</button>
                        <span style="min-width: 30px; text-align: center; font-weight: bold;">${item.quantity}</span>
                        <button onclick="updateQuantity(${idx}, 1)" class="quantity-btn">+</button>
                        <span style="margin-left: 10px; font-weight: bold; color: #4d96ff;">R$ ${itemTotal.toFixed(2)}</span>
                        <button onclick="removeFromCart(${idx})" class="remove-item-btn" style="background: none; border: none; color: #dc3545; font-size: 20px; cursor: pointer;">√ó</button>
                    </div>
                `;
                cartEl.appendChild(cartItem);
            });
            
            let deliveryFee = 0;
            if (state.deliveryType === 'delivery') {
                deliveryFee = state.deliveryFee || 0;
                if (subtotal >= CONFIG.deliveryRates.freeDeliveryMin) deliveryFee = 0;
                
                deliveryRow.style.display = 'flex';
                deliveryFeeEl.textContent = deliveryFee.toFixed(2);
                
                if (state.deliveryDistance) {
                    distanceRow.style.display = 'flex';
                    distanceValueEl.textContent = state.deliveryDistance.toFixed(1);
                } else {
                    distanceRow.style.display = 'none';
                }
            } else {
                deliveryRow.style.display = 'none';
                distanceRow.style.display = 'none';
            }
            
            const total = subtotal + deliveryFee;
            subtotalEl.textContent = subtotal.toFixed(2);
            totalEl.textContent = total.toFixed(2);
            validateForm();
        }

        function updateQuantity(index, change) {
            if (state.cart[index]) {
                const newQty = state.cart[index].quantity + change;
                if (newQty < 1) removeFromCart(index);
                else if (newQty > 50) showNotification('‚ùå M√°ximo 50 unidades', 'error');
                else { state.cart[index].quantity = newQty; updateCart(); saveCart(); }
            }
        }

        function removeFromCart(index) {
            if (state.cart[index]) {
                const name = state.cart[index].name;
                state.cart.splice(index, 1);
                updateCart(); saveCart();
                showNotification(`üóëÔ∏è ${name} removido`);
            }
        }

        function clearCart() {
            if (state.cart.length === 0) return;
            if (confirm('Limpar carrinho?')) {
                state.cart = [];
                state.deliveryDistance = null;
                state.deliveryFee = 0;
                updateCart(); saveCart();
                showNotification('üóëÔ∏è Carrinho limpo');
            }
        }

        function saveCart() {
            localStorage.setItem('bebcom_cart', JSON.stringify({ items: state.cart, timestamp: Date.now() }));
        }

        function loadCart() {
            const saved = localStorage.getItem('bebcom_cart');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (Date.now() - (data.timestamp || 0) < 24 * 60 * 60 * 1000) state.cart = data.items || [];
                    else { localStorage.removeItem('bebcom_cart'); state.cart = []; }
                    updateCart();
                } catch (e) { state.cart = []; }
            }
        }

        // ============================================
        // C√ÅLCULO DE TAXA DE ENTREGA - ATUALIZADO
        // ============================================
        async function calculateDeliveryFee() {
            const street = document.getElementById('street').value.trim();
            const number = document.getElementById('number').value.trim();
            const neighborhood = document.getElementById('neighborhood').value.trim();
            const city = document.getElementById('city').value.trim() || 'Bauru';
            
            if (!street || !number || !neighborhood) {
                showNotification('‚ùå Preencha Rua, N√∫mero e Bairro', 'error');
                return;
            }

            const fullAddress = `${street}, ${number}, ${neighborhood}, ${city}, SP`;
            
            const statusEl = document.getElementById('deliveryCalculationStatus');
            statusEl.innerHTML = '<span class="loading-spinner"></span> Calculando dist√¢ncia...';
            
            try {
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`;
                const geocodeResponse = await fetch(geocodeUrl, {
                    headers: { 'User-Agent': 'BebCom-Delivery/1.0' }
                });
                
                if (!geocodeResponse.ok) throw new Error('Erro na geocodifica√ß√£o');
                
                const geocodeData = await geocodeResponse.json();
                
                if (geocodeData.length === 0) {
                    statusEl.innerHTML = '‚ùå Endere√ßo n√£o encontrado';
                    return;
                }
                
                const clientLat = parseFloat(geocodeData[0].lat);
                const clientLon = parseFloat(geocodeData[0].lon);
                
                const distance = calculateDistance(
                    CONFIG.storeLocation.lat, 
                    CONFIG.storeLocation.lng,
                    clientLat, 
                    clientLon
                );
                
                if (distance > CONFIG.deliveryRates.maxDistance) {
                    statusEl.innerHTML = `‚ùå Dist√¢ncia de ${distance.toFixed(1)}km excede o limite de ${CONFIG.deliveryRates.maxDistance}km`;
                    state.deliveryDistance = null;
                    state.deliveryFee = 0;
                    updateCart();
                    return;
                }
                
                if (distance < CONFIG.deliveryRates.minDistance) {
                    state.deliveryFee = CONFIG.deliveryRates.baseFee;
                } else {
                    state.deliveryFee = CONFIG.deliveryRates.baseFee + (distance * CONFIG.deliveryRates.perKm);
                }
                
                state.deliveryDistance = distance;
                
                statusEl.innerHTML = `‚úÖ Dist√¢ncia: ${distance.toFixed(1)}km - Taxa: R$ ${state.deliveryFee.toFixed(2)}`;
                updateCart();
                
            } catch (error) {
                console.error('Erro ao calcular dist√¢ncia:', error);
                statusEl.innerHTML = '‚ùå Erro ao calcular dist√¢ncia. Tente novamente.';
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ============================================
        // M√ÅSCARA PARA CPF
        // ============================================
        function setupCpfMask() {
            const cpfInput = document.getElementById('customerCpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let v = e.target.value.replace(/\D/g, '');
                    if (v.length > 11) v = v.substring(0, 11);
                    if (v.length > 0) {
                        if (v.length <= 3) v = v;
                        else if (v.length <= 6) v = v.substring(0, 3) + '.' + v.substring(3);
                        else if (v.length <= 9) v = v.substring(0, 3) + '.' + v.substring(3, 6) + '.' + v.substring(6);
                        else v = v.substring(0, 3) + '.' + v.substring(3, 6) + '.' + v.substring(6, 9) + '-' + v.substring(9, 11);
                    }
                    e.target.value = v;
                    validateForm();
                });
            }
        }

        // ============================================
        // ENTREGA E PAGAMENTO
        // ============================================
        function selectDeliveryType(type) {
            state.deliveryType = type;
            const pickupBtn = document.querySelectorAll('.delivery-option')[0];
            const deliveryBtn = document.querySelectorAll('.delivery-option')[1];
            const addressFields = document.getElementById('addressFields');
            const paymentLabel = document.getElementById('paymentLabel');
            const paymentMethods = document.getElementById('paymentMethods');
            const payButton = document.getElementById('payButton');
            const whatsappBtn = document.getElementById('whatsappButton');
            
            if (type === 'pickup') {
                pickupBtn.classList.add('selected'); deliveryBtn.classList.remove('selected');
                addressFields.style.display = 'none'; paymentLabel.style.display = 'none';
                paymentMethods.style.display = 'none'; 
                payButton.disabled = true;
                payButton.innerHTML = 'üè™ Retirada no Local';
                state.paymentMethod = null; 
                state.paymentConfirmed = false;
                whatsappBtn.innerHTML = 'üì± Enviar Pedido';
                whatsappBtn.disabled = true;
                
                document.getElementById('deliveryRow').style.display = 'none';
                document.getElementById('distanceRow').style.display = 'none';
            } else {
                pickupBtn.classList.remove('selected'); deliveryBtn.classList.add('selected');
                addressFields.style.display = 'block'; paymentLabel.style.display = 'block';
                paymentMethods.style.display = 'grid'; 
                payButton.disabled = false;
                selectPaymentMethod('credit_card');
                payButton.innerHTML = 'üí∞ Pagar com Cart√£o';
            }
            updateCart(); 
            validateForm();
        }

        function selectPaymentMethod(method) {
            if (state.deliveryType !== 'delivery') return;
            state.paymentMethod = method;
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            const selected = document.querySelector('.payment-method');
            if (selected) selected.classList.add('selected');
        }

        function validateForm() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const cpf = document.getElementById('customerCpf').value.trim();
            const whatsappBtn = document.getElementById('whatsappButton');
            let isValid = true;
            
            if (name.length < 3) isValid = false;
            
            const phoneClean = phone.replace(/\D/g, '');
            if (phoneClean.length < 10 || phoneClean.length > 11) isValid = false;
            
            if (state.deliveryType === 'delivery') {
                if (!email || !email.includes('@') || !email.includes('.')) isValid = false;
                
                const cpfClean = cpf.replace(/\D/g, '');
                if (cpfClean.length !== 11) isValid = false;
                
                const street = document.getElementById('street').value.trim();
                const number = document.getElementById('number').value.trim();
                const neighborhood = document.getElementById('neighborhood').value.trim();
                
                if (!street || street.length < 3) isValid = false;
                if (!number) isValid = false;
                if (!neighborhood || neighborhood.length < 3) isValid = false;
                
                if (!state.deliveryDistance) isValid = false;
                
                if (state.paymentConfirmed) {
                    whatsappBtn.disabled = state.whatsappSent; // NOVO: Desabilitar se j√° enviou
                    whatsappBtn.innerHTML = 'üì± Enviar Pedido (Pago)';
                } else {
                    whatsappBtn.disabled = true;
                    whatsappBtn.innerHTML = 'üì± Enviar Pedido (Aguardando Pagamento)';
                }
            } else {
                whatsappBtn.disabled = !(state.cart.length > 0 && name.length >= 3 && phoneClean.length >= 10);
                whatsappBtn.innerHTML = 'üì± Enviar Pedido';
            }
            
            return isValid;
        }

        function validateOrder() {
            const errors = [];
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const cpf = document.getElementById('customerCpf').value.trim();
            
            if (!name) errors.push('‚Ä¢ Nome obrigat√≥rio');
            if (!phone || phone.replace(/\D/g, '').length < 10) errors.push('‚Ä¢ WhatsApp inv√°lido');
            if (state.cart.length === 0) errors.push('‚Ä¢ Carrinho vazio');
            
            if (state.deliveryType === 'delivery') {
                if (!email || !email.includes('@') || !email.includes('.')) errors.push('‚Ä¢ E-mail v√°lido obrigat√≥rio');
                
                const cpfClean = cpf.replace(/\D/g, '');
                if (cpfClean.length !== 11) errors.push('‚Ä¢ CPF inv√°lido (11 d√≠gitos)');
                
                const street = document.getElementById('street').value.trim();
                const number = document.getElementById('number').value.trim();
                const neighborhood = document.getElementById('neighborhood').value.trim();
                
                if (!street) errors.push('‚Ä¢ Rua obrigat√≥ria');
                if (!number) errors.push('‚Ä¢ N√∫mero obrigat√≥rio');
                if (!neighborhood) errors.push('‚Ä¢ Bairro obrigat√≥rio');
                
                if (!state.deliveryDistance) errors.push('‚Ä¢ Calcule a taxa de entrega');
            }
            
            return errors;
        }

        function prepareOrderData() {
            const items = state.cart.map(item => ({
                id: item.productId,
                title: item.name,
                description: item.flavors ? `Sabor: ${JSON.stringify(item.flavors)}` : '',
                quantity: item.quantity,
                unit_price: item.price
            }));
            
            const subtotal = items.reduce((sum, i) => sum + (i.quantity * i.unit_price), 0);
            let deliveryFee = 0;
            let total = subtotal;
            
            if (state.deliveryType === 'delivery') {
                deliveryFee = state.deliveryFee || 0;
                if (subtotal >= CONFIG.deliveryRates.freeDeliveryMin) deliveryFee = 0;
                total = subtotal + deliveryFee;
            }
            
            return { items, subtotal, deliveryFee, total };
        }

        // ============================================
        // PROCESSAMENTO DE PAGAMENTO COM MERCADO PAGO - ATUALIZADO COM CPF
        // ============================================
        async function processPayment() {
            if (state.deliveryType === 'pickup') {
                showNotification('‚úÖ Pagamento ser√° realizado na retirada', 'info');
                enableWhatsAppButton();
                return;
            }
            
            if (state.paymentProcessing) return;
            
            const errors = validateOrder();
            if (errors.length > 0) { 
                showNotification(errors.join('\n'), 'error'); 
                return; 
            }
            
            if (!state.backendOnline) {
                showNotification('‚ö†Ô∏è Servidor offline. Pagamento n√£o dispon√≠vel no momento.', 'error');
                return;
            }
            
            // NOVO: Salvar dados do cliente antes de redirecionar
            saveCustomerDataBeforePayment();
            
            state.paymentProcessing = true;
            const button = document.getElementById('payButton');
            const original = button.innerHTML;
            const statusDiv = document.getElementById('paymentStatus');
            
            button.innerHTML = '<span class="loading-spinner"></span> Gerando pagamento...';
            button.disabled = true;
            statusDiv.style.display = 'block';
            statusDiv.className = 'payment-status info';
            statusDiv.innerHTML = 'üîÑ Gerando link de pagamento...';
            
            try {
                const orderData = prepareOrderData();
                const orderId = 'BEB' + Date.now().toString().slice(-8);
                state.currentOrderId = orderId;
                
                const cpf = document.getElementById('customerCpf').value.trim().replace(/\D/g, '');
                
                const customer = {
                    name: document.getElementById('customerName').value.trim(),
                    email: document.getElementById('customerEmail').value.trim(),
                    phone: document.getElementById('customerPhone').value.trim(),
                    cpf: cpf
                };
                
                let address = null;
                if (state.deliveryType === 'delivery') {
                    const street = document.getElementById('street').value.trim();
                    const number = document.getElementById('number').value.trim();
                    const neighborhood = document.getElementById('neighborhood').value.trim();
                    const city = document.getElementById('city').value.trim() || 'Bauru';
                    const complement = document.getElementById('addressComplement').value.trim();
                    
                    address = {
                        street: `${street}, ${number}`,
                        neighborhood: neighborhood,
                        city: city,
                        complement: complement,
                        fullAddress: `${street}, ${number} - ${neighborhood}, ${city}`
                    };
                }
                
                const paymentData = {
                    orderId: orderId,
                    customer: customer,
                    items: orderData.items,
                    total: orderData.total,
                    deliveryFee: orderData.deliveryFee,
                    deliveryType: state.deliveryType,
                    paymentMethod: state.paymentMethod,
                    address: address,
                    notificationUrl: `${CONFIG.backendUrl}/api/webhooks/mercadopago`,
                    redirectUrls: {
                        success: `${window.location.origin}${window.location.pathname}?status=approved&order_id=${orderId}`,
                        failure: `${window.location.origin}${window.location.pathname}?status=failure`,
                        pending: `${window.location.origin}${window.location.pathname}?status=pending`
                    }
                };
                
                const response = await fetch(`${CONFIG.backendUrl}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erro ao criar pagamento');
                }
                
                const data = await response.json();
                
                if (data.success && data.initPoint) {
                    sessionStorage.setItem('bebcom_last_order', JSON.stringify({
                        orderId: orderId,
                        preferenceId: data.preferenceId,
                        confirmed: false,
                        timestamp: Date.now()
                    }));
                    
                    statusDiv.innerHTML = 'üîÑ Redirecionando para o Mercado Pago...';
                    window.location.href = data.initPoint;
                } else {
                    throw new Error('Resposta inv√°lida do servidor');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no pagamento:', error);
                statusDiv.className = 'payment-status error';
                statusDiv.innerHTML = `‚ùå Erro: ${error.message}`;
                button.innerHTML = original;
                button.disabled = false;
                state.paymentProcessing = false;
            }
        }

        function enableWhatsAppButton() {
            state.paymentConfirmed = true;
            state.whatsappSent = false; // NOVO: Resetar flag quando pagamento confirmado
            const whatsappBtn = document.getElementById('whatsappButton');
            whatsappBtn.disabled = false;
            whatsappBtn.innerHTML = 'üì± Enviar Pedido (Pago)';
            validateForm();
        }

        // ============================================
        // WHATSAPP - ATUALIZADO COM CAMPOS SEPARADOS
        // ============================================
        function sendToWhatsApp() {
            if (!validateForm()) { 
                showNotification('Complete todas as informa√ß√µes', 'error'); 
                return; 
            }
            
            if (state.deliveryType === 'delivery' && !state.paymentConfirmed) {
                showNotification('‚ùå Complete o pagamento antes de enviar', 'error');
                return;
            }
            
            // NOVO: Impedir envio duplicado
            if (state.whatsappSent) {
                showNotification('‚ö†Ô∏è Pedido j√° foi enviado!', 'warning');
                return;
            }
            
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const cpf = document.getElementById('customerCpf').value.trim();
            
            const street = document.getElementById('street')?.value.trim() || '';
            const number = document.getElementById('number')?.value.trim() || '';
            const neighborhood = document.getElementById('neighborhood')?.value.trim() || '';
            const city = document.getElementById('city')?.value.trim() || 'Bauru';
            const complement = document.getElementById('addressComplement')?.value.trim() || '';
            
            const order = prepareOrderData();
            const orderId = state.currentOrderId || 'BEB' + Date.now().toString().slice(-8);
            
            let msg = `*üçπ PEDIDO BEBCOM DELIVERY*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìã *Pedido:* ${orderId}\nüë§ *Cliente:* ${name}\nüì± *WhatsApp:* ${phone}\n‚úâÔ∏è *E-mail:* ${email}\nüÜî *CPF:* ${cpf}\nüì¶ *Tipo:* ${state.deliveryType === 'delivery' ? 'ENTREGA' : 'RETIRADA'}\n`;
            
            if (state.deliveryType === 'delivery') {
                msg += `üìç *Endere√ßo:* ${street}, ${number}\n`;
                msg += `üèòÔ∏è *Bairro:* ${neighborhood}\n`;
                msg += `üèôÔ∏è *Cidade:* ${city}\n`;
                if (complement) msg += `üè† *Complemento:* ${complement}\n`;
                msg += `üìè *Dist√¢ncia:* ${state.deliveryDistance ? state.deliveryDistance.toFixed(1) + 'km' : 'N/A'}\n`;
                msg += `üí≥ *Pagamento:* Cart√£o ‚úÖ PAGO (Mercado Pago)\n`;
            } else {
                msg += `üí≥ *Pagamento:* Na retirada\n`;
            }
            
            msg += `üïí *Data:* ${new Date().toLocaleString('pt-BR')}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n*üõí ITENS:*\n`;
            
            order.items.forEach((item, i) => {
                const total = item.quantity * item.unit_price;
                msg += `\n${i+1}. ${item.title}\n`;
                if (item.description) msg += `   üìù ${item.description}\n`;
                msg += `   ${item.quantity}x R$ ${item.unit_price.toFixed(2)} = R$ ${total.toFixed(2)}\n`;
            });
            
            msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüí∞ *Subtotal:* R$ ${order.subtotal.toFixed(2)}\n`;
            if (state.deliveryType === 'delivery') msg += `üöö *Entrega:* R$ ${order.deliveryFee.toFixed(2)}\n`;
            msg += `üíµ *TOTAL:* R$ ${order.total.toFixed(2)}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚úÖ *Pedido confirmado e PAGO!*\nüéâ Obrigado pela prefer√™ncia!`;
            
            window.open(`https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            
            // NOVO: Marcar como enviado e desabilitar bot√£o
            state.whatsappSent = true;
            const whatsappBtn = document.getElementById('whatsappButton');
            whatsappBtn.disabled = true;
            whatsappBtn.innerHTML = '‚úÖ Pedido Enviado';
            
            showNotification('‚úÖ Pedido enviado!');
            
            if (state.deliveryType === 'pickup') {
                state.paymentConfirmed = false;
            }
        }

        // ============================================
        // ADMINISTRA√á√ÉO SEGURA
        // ============================================
        function initAdminSystem() {
            const adminBtn = document.getElementById('adminButton');
            const adminClose = document.getElementById('adminClose');
            const adminModal = document.getElementById('adminModal');
            
            adminBtn.addEventListener('click', openAdminPanel);
            adminClose.addEventListener('click', closeAdminPanel);
            adminModal.addEventListener('click', function(e) { if (e.target === this) closeAdminPanel(); });
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.altKey && e.key === 'a') { e.preventDefault(); openAdminPanel(); }
                if (e.key === 'Escape') closeAdminPanel();
            });
        }

        function openAdminPanel() {
            document.getElementById('adminModal').style.display = 'block';
            if (isAdminAuthenticated()) {
                state.adminAuthenticated = true;
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('adminMain').style.display = 'block';
                document.getElementById('adminActions').style.display = 'flex';
                loadAdminProducts();
            } else {
                document.getElementById('passwordSection').style.display = 'block';
                document.getElementById('adminMain').style.display = 'none';
                document.getElementById('adminActions').style.display = 'none';
                document.getElementById('adminPassword').focus();
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function isAdminAuthenticated() {
            const token = sessionStorage.getItem('admin_token');
            const expires = sessionStorage.getItem('admin_expires');
            if (!token || !expires) return false;
            if (Date.now() > parseInt(expires)) {
                sessionStorage.removeItem('admin_token');
                sessionStorage.removeItem('admin_expires');
                state.adminAuthenticated = false;
                return false;
            }
            state.adminToken = token;
            state.adminAuthenticated = true;
            return true;
        }

        async function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            const btn = document.querySelector('.password-button');
            const original = btn.innerHTML;
            
            if (!password) { showNotification('‚ùå Digite a senha', 'error'); return; }
            
            btn.innerHTML = '<span class="loading-spinner"></span> Verificando...';
            btn.disabled = true;
            
            try {
                const url = `${CONFIG.backendUrl}/api/admin/verify`;
                console.log('üì° Enviando requisi√ß√£o para:', url);
                
                const response = await fetch(url, {
                    method: 'POST', mode: 'cors', credentials: 'include',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                console.log('üì• Status da resposta:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        sessionStorage.setItem('admin_token', data.token);
                        sessionStorage.setItem('admin_expires', (Date.now() + 30 * 60 * 1000).toString());
                        state.adminAuthenticated = true;
                        state.adminToken = data.token;
                        document.getElementById('passwordSection').style.display = 'none';
                        document.getElementById('adminMain').style.display = 'block';
                        document.getElementById('adminActions').style.display = 'flex';
                        loadAdminProducts();
                        showNotification('‚úÖ Acesso concedido');
                    } else throw new Error(data.error || 'Senha incorreta');
                } else if (response.status === 401) throw new Error('Senha incorreta');
                else if (response.status === 429) throw new Error('Muitas tentativas. Aguarde 15 minutos.');
                else throw new Error(`Erro ${response.status}: ${response.statusText}`);
            } catch (error) {
                console.error('‚ùå Erro detalhado:', error);
                showNotification('‚ùå ' + error.message, 'error');
                document.getElementById('adminPassword').value = '';
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        function getAdminHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (state.adminToken) headers['Authorization'] = `Bearer ${state.adminToken}`;
            return headers;
        }

        function loadAdminProducts() {
            const container = document.getElementById('adminMain');
            container.innerHTML = '';
            
            const categories = [
                { id: 'drinks-whisky', name: 'ü•É Drinks Whisky' },
                { id: 'drinks-gin', name: 'üç∏ Drinks Gin' },
                { id: 'drinks-vodka', name: 'üç∏ Drinks Vodka' },
                { id: 'drinks-vinho', name: 'üç∑ Drinks Vinho' },
                { id: 'cervejas', name: 'üç∫ Cervejas' },
                { id: 'destilados', name: 'ü•É Destilados' },
                { id: 'aguas', name: 'üíß √Åguas' },
                { id: 'refri-latas', name: 'ü•§ Refri Latas' },
                { id: 'refri-pet', name: 'ü•§ Refri PET' },
                { id: 'sucos', name: 'üßÉ Sucos' },
                { id: 'energeticos', name: '‚ö° Energ√©ticos' },
                { id: 'gelo-carvao', name: 'üßä Gelo/Carv√£o' },
                { id: 'salgadinhos', name: 'ü•® Salgadinhos' },
                { id: 'doces', name: 'üç¨ Doces' }
            ];
            
            categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'admin-category-section';
                section.style.marginBottom = '30px';
                section.style.background = 'rgba(0,0,0,0.2)';
                section.style.padding = '20px';
                section.style.borderRadius = '12px';
                section.innerHTML = `<h3 style="color: #60a5fa; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;">${cat.name}</h3>`;
                
                const grid = document.createElement('div');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                grid.style.gap = '12px';
                
                const catProducts = products[cat.id] || [];
                catProducts.forEach(product => {
                    const available = isProductAvailable(product.id);
                    
                    const item = document.createElement('div');
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    item.style.alignItems = 'center';
                    item.style.padding = '15px';
                    item.style.background = available ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
                    item.style.borderRadius = '10px';
                    item.style.border = `1px solid ${available ? '#10b981' : '#ef4444'}`;
                    
                    item.innerHTML = `
                        <div>
                            <div style="font-weight: bold; color: white;">${product.name}</div>
                            <div style="font-size: 13px; color: #94a3b8;">R$ ${product.price.toFixed(2)}</div>
                            ${product.requiresFlavorSelection ? '<div style="font-size: 12px; color: #60a5fa; margin-top: 4px;">‚ö° Com sabores</div>' : ''}
                        </div>
                        <label style="position: relative; display: inline-block; width: 60px; height: 30px; cursor: pointer;">
                            <input type="checkbox" 
                                   style="opacity: 0; width: 0; height: 0; position: absolute;" 
                                   id="admin_toggle_${product.id}"
                                   ${available ? 'checked' : ''}
                                   onchange="adminToggleProductAvailability('${product.id}', this.checked)">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${available ? '#10b981' : '#dc2626'}; transition: .4s; border-radius: 30px; pointer-events: none;"></span>
                            <span style="position: absolute; content: ''; height: 22px; width: 22px; left: ${available ? '34px' : '4px'}; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; pointer-events: none;"></span>
                        </label>
                    `;
                    
                    grid.appendChild(item);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });
        }

        function adminToggleProductAvailability(productId, isAvailable) {
            state.productAvailability[productId] = isAvailable;
            localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
            
            const toggle = document.getElementById(`admin_toggle_${productId}`);
            if (toggle) {
                const span = toggle.nextElementSibling;
                const slider = span.nextElementSibling;
                if (span) span.style.backgroundColor = isAvailable ? '#10b981' : '#dc2626';
                if (slider) slider.style.left = isAvailable ? '34px' : '4px';
            }
            
            const product = findProductById(productId);
            const elements = document.querySelectorAll(`[data-product-id="${productId}"]`);
            
            elements.forEach(el => {
                if (isAvailable) {
                    el.classList.remove('unavailable');
                    const btn = el.querySelector('button');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = product?.requiresFlavorSelection ? '‚ö° Escolher Sabores' : 'üõí Adicionar';
                    }
                } else {
                    el.classList.add('unavailable');
                    const btn = el.querySelector('button');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '‚ùå Indispon√≠vel';
                    }
                }
            });
            
            showNotification(`${product?.name || 'Produto'} ${isAvailable ? '‚úÖ dispon√≠vel' : '‚ùå indispon√≠vel'}`, 'info');
        }

        function setAllAvailable(isAvailable) {
            Object.keys(products).forEach(cat => {
                products[cat].forEach(p => {
                    state.productAvailability[p.id] = isAvailable;
                    
                    const toggle = document.getElementById(`admin_toggle_${p.id}`);
                    if (toggle) {
                        toggle.checked = isAvailable;
                        const span = toggle.nextElementSibling;
                        const slider = span.nextElementSibling;
                        if (span) span.style.backgroundColor = isAvailable ? '#10b981' : '#dc2626';
                        if (slider) slider.style.left = isAvailable ? '34px' : '4px';
                    }
                    
                    const elements = document.querySelectorAll(`[data-product-id="${p.id}"]`);
                    elements.forEach(el => {
                        if (isAvailable) {
                            el.classList.remove('unavailable');
                            const btn = el.querySelector('button');
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = p.requiresFlavorSelection ? '‚ö° Escolher Sabores' : 'üõí Adicionar';
                            }
                        } else {
                            el.classList.add('unavailable');
                            const btn = el.querySelector('button');
                            if (btn) {
                                btn.disabled = true;
                                btn.innerHTML = '‚ùå Indispon√≠vel';
                            }
                        }
                    });
                });
            });
            
            localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
            showNotification(isAvailable ? '‚úÖ Todos dispon√≠veis' : '‚ùå Todos indispon√≠veis');
        }

        async function saveAvailability() {
            if (!isAdminAuthenticated()) {
                showNotification('üîê Sess√£o expirada. Fa√ßa login novamente.', 'error');
                openAdminPanel();
                return;
            }
            
            const btn = document.querySelector('.save-btn');
            const original = btn.innerHTML;
            
            btn.innerHTML = '<span class="loading-spinner"></span> Salvando no servidor...';
            btn.disabled = true;
            
            try {
                localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                
                if (CONFIG.backendUrl) {
                    await checkBackendHealth();
                    
                    if (state.backendOnline) {
                        const headers = getAdminHeaders();
                        
                        const prodRes = await fetch(`${CONFIG.backendUrl}/api/admin/product-availability/bulk`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ 
                                productAvailability: state.productAvailability,
                                adminName: 'Admin BebCom',
                                source: 'frontend'
                            })
                        });
                        
                        const flavRes = await fetch(`${CONFIG.backendUrl}/api/admin/flavor-availability/bulk`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ 
                                flavorAvailability: state.flavorAvailability,
                                adminName: 'Admin BebCom',
                                source: 'frontend'
                            })
                        });
                        
                        if (prodRes.ok && flavRes.ok) {
                            showNotification('‚úÖ Dados salvos no servidor (MongoDB)!');
                            await loadAvailability();
                            setTimeout(() => closeAdminPanel(), 1500);
                        } else {
                            const prodError = prodRes.ok ? '' : ' produtos';
                            const flavError = flavRes.ok ? '' : ' sabores';
                            showNotification(`‚ö†Ô∏è Erro ao salvar:${prodError}${flavError}. Dados salvos localmente.`, 'warning');
                            setTimeout(() => closeAdminPanel(), 2000);
                        }
                    } else {
                        showNotification('‚ö†Ô∏è Servidor offline. Dados salvos apenas localmente.', 'warning');
                        setTimeout(() => closeAdminPanel(), 2000);
                    }
                } else {
                    showNotification('‚ö†Ô∏è URL do servidor n√£o configurada. Dados salvos localmente.', 'warning');
                    setTimeout(() => closeAdminPanel(), 2000);
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar:', error);
                showNotification('‚ùå Erro ao salvar no servidor. Dados mantidos localmente.', 'error');
                setTimeout(() => closeAdminPanel(), 2000);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        function resetAvailability() {
            if (confirm('Restaurar todos os produtos como dispon√≠veis?')) {
                Object.keys(products).forEach(cat => {
                    products[cat].forEach(p => {
                        state.productAvailability[p.id] = true;
                    });
                });
                
                Object.keys(FLAVOR_CATALOG).forEach(type => {
                    FLAVOR_CATALOG[type].forEach(flavor => {
                        state.flavorAvailability[`${type}_${flavor}`] = true;
                    });
                });
                
                localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                
                if (document.getElementById('adminMain').style.display === 'block') {
                    loadAdminProducts();
                }
                
                updateMenuAvailability();
                showNotification('üîÑ Disponibilidade restaurada');
            }
        }

        async function syncAllFromServer() {
            if (!isAdminAuthenticated()) {
                showNotification('üîê Sess√£o expirada. Fa√ßa login novamente.', 'error');
                openAdminPanel();
                return;
            }
            
            const btn = document.querySelector('[onclick*="syncAllFromServer"]');
            const original = btn.innerHTML;
            
            btn.innerHTML = '<span class="loading-spinner"></span> Sincronizando do servidor...';
            btn.disabled = true;
            
            try {
                if (!CONFIG.backendUrl) {
                    showNotification('‚ùå URL do servidor n√£o configurada', 'error');
                    return;
                }
                
                await checkBackendHealth();
                
                if (state.backendOnline) {
                    const [productsRes, flavorsRes] = await Promise.all([
                        fetch(`${CONFIG.backendUrl}/api/product-availability`),
                        fetch(`${CONFIG.backendUrl}/api/flavor-availability`)
                    ]);
                    
                    let atualizado = false;
                    
                    if (productsRes.ok) {
                        const productData = await productsRes.json();
                        if (productData.success && productData.productAvailability) {
                            state.productAvailability = productData.productAvailability;
                            localStorage.setItem('bebcom_product_availability', JSON.stringify(state.productAvailability));
                            atualizado = true;
                        }
                    }
                    
                    if (flavorsRes.ok) {
                        const flavorData = await flavorsRes.json();
                        if (flavorData.success && flavorData.flavorAvailability) {
                            state.flavorAvailability = flavorData.flavorAvailability;
                            localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
                            atualizado = true;
                        }
                    }
                    
                    if (atualizado) {
                        updateMenuAvailability();
                        if (document.getElementById('adminMain').style.display === 'block') {
                            loadAdminProducts();
                        }
                        showNotification('‚úÖ Dados sincronizados do servidor (MongoDB)!');
                    } else {
                        showNotification('‚ö†Ô∏è Nenhum dado encontrado no servidor', 'warning');
                    }
                } else {
                    showNotification('‚ö†Ô∏è Servidor offline. Mantendo dados locais.', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o:', error);
                showNotification('‚ùå Erro ao sincronizar com o servidor', 'error');
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        }

        // ============================================
        // GERENCIAMENTO DE SABORES
        // ============================================
        function openFlavorManagement() {
            if (!isAdminAuthenticated()) {
                showNotification('üîê Sess√£o expirada. Fa√ßa login novamente.', 'error');
                openAdminPanel();
                return;
            }
            
            const container = document.getElementById('adminMain');
            container.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                        <button onclick="loadAdminProducts()" style="background: #3b82f6; color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer;">
                            ‚Ü©Ô∏è Voltar
                        </button>
                        <h3 style="color: #60a5fa; margin: 0;">üçπ Gerenciar Sabores</h3>
                    </div>
                    
                    <select id="flavorTypeSelect" style="width: 100%; padding: 15px; background: white; border: 1px solid #444; border-radius: 8px; color: black; margin-bottom: 20px;" onchange="loadFlavorsForType(this.value)">
                        <option value="">-- Selecione um tipo --</option>
                        ${Object.entries(FLAVOR_TYPES).map(([key, name]) => `<option value="${key}">${name}</option>`).join('')}
                    </select>
                    
                    <div id="flavorManagementSection" style="display: none;"></div>
                </div>
            `;
        }

        function loadFlavorsForType(flavorType) {
            const section = document.getElementById('flavorManagementSection');
            
            if (!flavorType) {
                section.style.display = 'none';
                return;
            }
            
            const flavors = FLAVOR_CATALOG[flavorType] || [];
            const typeName = FLAVOR_TYPES[flavorType] || flavorType;
            
            let html = `
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px;">
                    <h4 style="color: #94a3b8; margin-bottom: 15px;">Gerenciando: ${typeName}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">
            `;
            
            flavors.forEach(flavor => {
                const key = `${flavorType}_${flavor}`;
                const available = state.flavorAvailability[key] !== false;
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: ${available ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'}; border-radius: 8px; border: 1px solid ${available ? '#10b981' : '#ef4444'};">
                        <span style="color: white; font-weight: 500;">${flavor}</span>
                        <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                            <input type="checkbox" style="opacity: 0; width: 0; height: 0;" 
                                   ${available ? 'checked' : ''}
                                   onchange="toggleFlavorAvailability('${flavorType}', '${flavor}', this.checked)">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${available ? '#10b981' : '#dc2626'}; transition: .4s; border-radius: 24px;"></span>
                            <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; transform: ${available ? 'translateX(26px)' : 'none'};"></span>
                        </label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="setAllFlavorsAvailable('${flavorType}', true)" style="flex: 1; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">‚úÖ Todos</button>
                        <button onclick="setAllFlavorsAvailable('${flavorType}', false)" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">‚ùå Nenhum</button>
                    </div>
                </div>
            `;
            
            section.innerHTML = html;
            section.style.display = 'block';
        }

        function toggleFlavorAvailability(flavorType, flavorName, isAvailable) {
            const key = `${flavorType}_${flavorName}`;
            state.flavorAvailability[key] = isAvailable;
            localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
            loadFlavorsForType(flavorType);
            showNotification(`Sabor ${flavorName} ${isAvailable ? '‚úÖ dispon√≠vel' : '‚ùå indispon√≠vel'}`, 'info');
        }

        function setAllFlavorsAvailable(flavorType, makeAvailable) {
            const flavors = FLAVOR_CATALOG[flavorType] || [];
            flavors.forEach(flavor => {
                const key = `${flavorType}_${flavor}`;
                state.flavorAvailability[key] = makeAvailable;
            });
            localStorage.setItem('bebcom_flavor_availability', JSON.stringify(state.flavorAvailability));
            loadFlavorsForType(flavorType);
            showNotification(`Todos os sabores ${makeAvailable ? '‚úÖ dispon√≠veis' : '‚ùå indispon√≠veis'}`, 'info');
        }

        function syncPendingData() {
            console.log('üîÑ Sincroniza√ß√£o pendente...');
        }

        function updateMenuAvailability() {
            Object.keys(products).forEach(cat => {
                products[cat].forEach(p => {
                    const elements = document.querySelectorAll(`[data-product-id="${p.id}"]`);
                    const available = isProductAvailable(p.id);
                    const hasFlavors = p.requiresFlavorSelection || false;
                    
                    elements.forEach(el => {
                        if (available) {
                            el.classList.remove('unavailable');
                            const btn = el.querySelector('button');
                            if (btn) {
                                btn.disabled = false;
                                btn.innerHTML = hasFlavors ? '‚ö° Sabores' : 'üõí Adicionar';
                            }
                        } else {
                            el.classList.add('unavailable');
                            const btn = el.querySelector('button');
                            if (btn) {
                                btn.disabled = true;
                                btn.innerHTML = '‚ùå Indispon√≠vel';
                            }
                        }
                    });
                });
            });
        }

        // ============================================
        // UTILIT√ÅRIOS
        // ============================================
        function setupEventListeners() {
            const inputs = ['customerName', 'customerPhone', 'customerEmail', 'customerCpf', 'street', 'number', 'neighborhood', 'city'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', validateForm);
            });
            
            document.getElementById('number')?.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        }

        function setupPhoneMask() {
            const phone = document.getElementById('customerPhone');
            phone.addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 11) v = v.substring(0, 11);
                if (v.length > 0) {
                    if (v.length <= 2) v = `(${v}`;
                    else if (v.length <= 6) v = `(${v.substring(0, 2)}) ${v.substring(2)}`;
                    else v = `(${v.substring(0, 2)}) ${v.substring(2, 6)}-${v.substring(6, 11)}`;
                }
                e.target.value = v;
                validateForm();
            });
        }

        function showNotification(msg, type = 'success') {
            const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#17a2b8' };
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: ${colors[type]};
                color: white; padding: 16px 24px; border-radius: 10px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 10000;
                animation: slideIn 0.3s ease; font-weight: bold; max-width: 350px;
            `;
            notif.innerHTML = msg;
            document.body.appendChild(notif);
            setTimeout(() => { notif.style.animation = 'fadeIn 0.3s reverse'; setTimeout(() => notif.remove(), 300); }, 3000);
        }

        // ============================================
        // INICIALIZA√á√ÉO PRINCIPAL
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ BebCom Delivery - Produ√ß√£o com Mercado Pago');
            await loadSecureConfig();
            initStorage();
            initAdminSystem();
            initAgeVerification();
            setTimeout(checkBackendHealth, 2000);
        });

        // ============================================
        // EXPOR FUN√á√ïES GLOBAIS
        // ============================================
        window.showCategory = showCategory;
        window.handleAddToCart = handleAddToCart;
        window.updateQuantity = updateQuantity;
        window.removeFromCart = removeFromCart;
        window.clearCart = clearCart;
        window.selectDeliveryType = selectDeliveryType;
        window.selectPaymentMethod = selectPaymentMethod;
        window.processPayment = processPayment;
        window.sendToWhatsApp = sendToWhatsApp;
        window.confirmFlavorSelection = confirmFlavorSelection;
        window.cancelFlavorSelection = cancelFlavorSelection;
        window.checkAdminPassword = checkAdminPassword;
        window.setAllAvailable = setAllAvailable;
        window.saveAvailability = saveAvailability;
        window.resetAvailability = resetAvailability;
        window.openFlavorManagement = openFlavorManagement;
        window.loadFlavorsForType = loadFlavorsForType;
        window.toggleFlavorAvailability = toggleFlavorAvailability;
        window.setAllFlavorsAvailable = setAllFlavorsAvailable;
        window.syncAllFromServer = syncAllFromServer;
        window.adminToggleProductAvailability = adminToggleProductAvailability;
        window.loadAdminProducts = loadAdminProducts;
        window.calculateDeliveryFee = calculateDeliveryFee;
        window.handleSearch = handleSearch;
        window.clearSearch = clearSearch;

        // ============================================
        // NOVA FUN√á√ÉO: ABRIR PAINEL DE PEDIDOS
        // ============================================
        function openOrdersPanel() {
            window.open('painelendereco.html', '_blank');
        }
    </script>
</body>
</html>
